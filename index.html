<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Kitting - Aciérie</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a237e">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a237e;
            --primary-light: #534bae;
            --secondary: #ff6f00;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #212121;
            --text-light: #757575;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #e65100;
        }

        .btn-secondary {
            background: var(--primary-light);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid currentColor;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
        }

        /* Search & Filters */
        .search-section {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23757575' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E") no-repeat 0.75rem center;
            background-size: 20px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-btn[data-status="pret"].active {
            background: var(--success);
            border-color: var(--success);
        }

        .filter-btn[data-status="incomplet"].active {
            background: var(--warning);
            border-color: var(--warning);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            padding: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .stat-card.pret .stat-number { color: var(--success); }
        .stat-card.incomplet .stat-number { color: var(--warning); }

        /* Kitting Sections */
        .kitting-sections {
            padding: 0 1rem 1rem;
        }

        .kitting-section {
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .section-header.incomplet {
            border-left: 4px solid var(--warning);
        }

        .section-header.incomplet h3 {
            color: var(--warning);
        }

        .section-header.incomplet svg {
            fill: var(--warning);
        }

        .section-header.pret {
            border-left: 4px solid var(--success);
        }

        .section-header.pret h3 {
            color: var(--success);
        }

        .section-header.pret svg {
            fill: var(--success);
        }

        .section-count {
            background: var(--bg);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .section-header.incomplet .section-count {
            background: #fff3e0;
            color: var(--warning);
        }

        .section-header.pret .section-count {
            background: #e8f5e9;
            color: var(--success);
        }

        /* Kitting List */
        .kitting-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .kitting-list:empty::after {
            content: 'Aucun kitting dans cette section';
            display: block;
            text-align: center;
            padding: 1.5rem;
            color: var(--text-light);
            font-style: italic;
            background: white;
            border-radius: 8px;
        }

        .kitting-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .kitting-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .kitting-card.pret {
            border-left-color: var(--success);
        }

        .kitting-card.incomplet {
            border-left-color: var(--warning);
        }

        .kitting-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .kitting-ordre {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .kitting-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kitting-status.pret {
            background: #e8f5e9;
            color: var(--success);
        }

        .kitting-status.incomplet {
            background: #fff3e0;
            color: var(--warning);
        }

        .kitting-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .kitting-location {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .kitting-pieces {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .pieces-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pieces-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .pieces-progress {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Camera Section */
        .camera-section {
            margin-bottom: 1rem;
        }

        .camera-preview {
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .camera-preview video,
        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* Piece List */
        .piece-list {
            list-style: none;
        }

        .piece-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        .piece-item.received {
            background: #e8f5e9;
            border-color: var(--success);
        }

        .piece-item.received .piece-name {
            color: var(--success);
            font-weight: 500;
        }

        .piece-checkbox {
            width: 22px;
            height: 22px;
            accent-color: var(--success);
        }

        .piece-name {
            flex: 1;
        }

        .piece-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .piece-quantity-input {
            width: 60px;
            padding: 0.35rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }

        .piece-quantity-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .piece-quantity-display {
            font-weight: 500;
        }

        .piece-quantity-display.complete {
            color: var(--success);
        }

        .piece-quantity-display.incomplete {
            color: var(--warning);
        }

        .piece-remove {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            flex-shrink: 0;
        }

        /* Mobile optimizations for pieces */
        @media (max-width: 480px) {
            .piece-item {
                flex-wrap: wrap;
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .piece-checkbox {
                width: 28px;
                height: 28px;
                flex-shrink: 0;
            }

            .piece-name {
                flex: 1;
                min-width: 0;
                font-size: 0.9rem;
                word-break: break-word;
                order: 1;
            }

            .piece-quantity {
                order: 3;
                width: 100%;
                justify-content: flex-start;
                padding-left: 38px;
                margin-top: 0.25rem;
            }

            .piece-quantity-input {
                width: 70px;
                padding: 0.5rem;
                font-size: 1rem;
            }

            .piece-quantity-display {
                font-size: 0.9rem;
                min-width: 50px;
            }

            .piece-remove {
                order: 2;
                padding: 0.25rem;
            }

            .piece-remove svg {
                width: 24px;
                height: 24px;
            }

            /* Section pièces en pleine largeur sur mobile */
            .pieces-section {
                grid-column: 1 / -1 !important;
            }

            .pieces-section h3 {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        /* Tablet optimizations */
        @media (min-width: 481px) and (max-width: 768px) {
            .piece-item {
                gap: 0.5rem;
            }

            .piece-quantity-input {
                width: 65px;
            }
        }

        /* OCR Results */
        .ocr-results {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .ocr-results h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .ocr-text {
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .extracted-data {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .extracted-data p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .extracted-data .extracted-value {
            color: var(--primary);
            font-weight: 600;
            background: white;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-left: 0.25rem;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 5.5rem;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: transform 0.2s;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        /* Detail View */
        .detail-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .detail-view.active {
            transform: translateX(0);
        }

        .detail-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .detail-content {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .detail-section {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .detail-section h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-section h3::before {
            content: '';
            width: 4px;
            height: 1.2em;
            background: var(--primary);
            border-radius: 2px;
        }

        .detail-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        /* Desktop layout for detail view */
        @media (min-width: 768px) {
            .detail-view {
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding: 2rem;
            }

            .detail-view .detail-inner {
                background: var(--bg);
                border-radius: 16px;
                width: 100%;
                max-width: 900px;
                max-height: calc(100vh - 4rem);
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            }

            .detail-header {
                border-radius: 16px 16px 0 0;
                padding: 1.25rem 1.5rem;
            }

            .detail-content {
                padding: 1.5rem;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .detail-content .detail-section:first-child {
                grid-column: 1 / -1;
            }

            .detail-content .detail-actions {
                grid-column: 1 / -1;
                grid-template-columns: repeat(4, 1fr);
            }

            .detail-section {
                padding: 1.5rem;
                margin-bottom: 0;
            }

            .detail-section h3 {
                font-size: 1.1rem;
                margin-bottom: 1.25rem;
            }
        }

        @media (min-width: 1024px) {
            .detail-content {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .detail-content .detail-section:first-child {
                grid-column: 1 / -1;
            }

            .detail-content .detail-section.pieces-section {
                grid-column: 1 / 3;
            }
        }

        /* Info grid in detail view */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text);
        }

        .actions-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .actions-grid .btn {
            justify-content: center;
        }

        @media (min-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .info-item {
                padding: 0.75rem;
            }

            .actions-grid {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .actions-grid .btn {
                flex: 1;
                min-width: 150px;
            }
        }

        @media (min-width: 1024px) {
            .info-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            border-top: 1px solid var(--border);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            color: var(--text-light);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            font-size: 0.75rem;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        /* Page container */
        .page {
            display: none;
            padding-bottom: 70px;
        }

        .page.active {
            display: block;
        }

        /* Map Page */
        .map-container {
            padding: 1rem;
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .map-header h2 {
            font-size: 1.1rem;
            color: var(--primary);
        }

        .map-toolbar {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-toolbar .btn {
            padding: 0.5rem 0.65rem;
            font-size: 0.8rem;
        }

        .map-toolbar .btn svg {
            width: 16px;
            height: 16px;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.15rem;
            background: var(--bg);
            padding: 0.2rem;
            border-radius: 8px;
        }

        .zoom-controls .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
        }

        .zoom-level {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--primary);
        }

        /* Mobile: cacher le texte des boutons */
        @media (max-width: 600px) {
            .map-toolbar .btn-text {
                display: none;
            }

            .map-toolbar .btn {
                padding: 0.5rem;
            }

            .map-header h2 {
                font-size: 1rem;
                width: 100%;
            }
        }

        /* 2D Floor Plan */
        .floor-plan-wrapper {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 300px;
        }

        .floor-plan {
            width: 100%;
            height: 100%;
            position: relative;
            background:
                linear-gradient(90deg, #e0e0e0 1px, transparent 1px),
                linear-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #fafafa;
            overflow: scroll;
            min-height: 300px;
            max-height: 70vh;
            /* Activer le scroll tactile fluide */
            -webkit-overflow-scrolling: touch;
            cursor: grab;
            touch-action: pan-x pan-y;
        }

        .floor-plan.panning {
            cursor: grabbing;
            user-select: none;
        }

        /* Scrollbars visibles */
        .floor-plan::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .floor-plan::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        .floor-plan::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 5px;
            border: 2px solid #f1f1f1;
        }

        .floor-plan::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .floor-plan-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-width: 500px;
            min-height: 350px;
            transform-origin: top left;
        }

        /* Mobile floor plan */
        @media (max-width: 600px) {
            .floor-plan-wrapper {
                min-height: 250px;
            }

            .floor-plan {
                min-height: 250px;
            }

            .floor-plan-inner {
                min-width: 350px;
                min-height: 280px;
            }

            .map-zone {
                min-width: 100px;
                min-height: 70px;
                padding: 0.35rem;
            }

            .zone-title {
                font-size: 0.8rem;
            }

            .map-kitting {
                font-size: 0.65rem;
                padding: 0.25rem 0.4rem;
            }
        }

        /* Building outline */
        .building-outline {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 3px solid var(--primary);
            border-radius: 4px;
            background: rgba(26, 35, 126, 0.02);
        }

        .building-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
        }

        /* Storage Zone on map */
        .map-zone {
            position: absolute;
            background: rgba(255, 255, 255, 0.75);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 120px;
            min-height: 80px;
            cursor: move;
            transition: box-shadow 0.2s, border-color 0.2s, background 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            backdrop-filter: blur(2px);
        }

        .floor-plan.has-background .map-zone {
            background: rgba(255, 255, 255, 0.6);
            border-width: 3px;
        }

        .map-zone:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .map-zone.editing {
            border-color: var(--secondary);
            border-style: dashed;
        }

        .map-zone.has-pret {
            border-left: 4px solid var(--success);
        }

        .map-zone.has-incomplet {
            border-left: 4px solid var(--warning);
        }

        .map-zone.has-both {
            border-left: 4px solid;
            border-image: linear-gradient(to bottom, var(--success) 50%, var(--warning) 50%) 1;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.95);
            margin: -0.5rem -0.5rem 0.5rem -0.5rem;
            padding: 0.5rem;
            border-radius: 6px 6px 0 0;
        }

        .zone-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary);
            text-shadow: 0 0 2px white;
        }

        .zone-count {
            font-size: 0.7rem;
            background: var(--primary);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .zone-kittings {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 150px;
            overflow-y: auto;
        }

        /* Sub-zones grid layout */
        .zone-subzones {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 6px;
            margin-top: 0.5rem;
        }

        .sub-zone {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 0.4rem;
            min-height: 60px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-zone:hover {
            border-color: var(--primary-light);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .sub-zone.has-kitting {
            border-color: var(--primary);
        }

        .sub-zone.has-pret {
            border-color: var(--success);
            background: rgba(232, 245, 233, 0.9);
        }

        .sub-zone.has-incomplet {
            border-color: var(--warning);
            background: rgba(255, 243, 224, 0.9);
        }

        .sub-zone-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sub-zone-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sub-zone-kitting {
            font-size: 0.65rem;
            padding: 0.2rem 0.35rem;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .sub-zone-kitting.pret {
            background: var(--success);
            color: white;
        }

        .sub-zone-kitting.incomplet {
            background: var(--warning);
            color: white;
        }

        .sub-zone-empty {
            font-size: 0.6rem;
            color: var(--text-light);
            font-style: italic;
            text-align: center;
        }

        /* Arrow buttons for subzone reordering */
        .btn-arrow {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0;
            width: 20px;
            height: 16px;
            cursor: pointer;
            font-size: 0.6rem;
            line-height: 1;
            color: var(--text-light);
            transition: all 0.15s;
        }

        .btn-arrow:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .subzone-edit-item {
            transition: background 0.15s;
        }

        .subzone-edit-item:hover {
            background: var(--primary-light) !important;
        }

        .subzone-name-input {
            border: 1px solid transparent !important;
            background: transparent !important;
        }

        .subzone-name-input:focus {
            border-color: var(--primary) !important;
            background: white !important;
        }

        /* Zone edit button */
        .zone-edit-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 3px 5px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zone-edit-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .map-kitting {
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            text-shadow: none;
        }

        .map-kitting.pret {
            background: rgba(232, 245, 233, 0.95);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .map-kitting.incomplet {
            background: rgba(255, 243, 224, 0.95);
            color: #e65100;
            border: 1px solid #e65100;
        }

        .map-kitting:hover {
            transform: translateX(3px);
        }

        .map-kitting .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .map-kitting.pret .status-dot { background: var(--success); }
        .map-kitting.incomplet .status-dot { background: var(--warning); }

        .empty-zone-msg {
            color: var(--text-light);
            font-size: 0.7rem;
            font-style: italic;
            text-align: center;
            padding: 0.5rem;
        }

        /* Resize handle */
        .zone-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            cursor: se-resize;
            opacity: 0.5;
        }

        .zone-resize::after {
            content: '';
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 8px;
            height: 8px;
            border-right: 2px solid var(--text-light);
            border-bottom: 2px solid var(--text-light);
        }

        /* Responsive classes */
        .desktop-only {
            display: block;
        }
        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }
            .mobile-only {
                display: block !important;
            }
            .map-toolbar {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .map-toolbar .zoom-controls {
                display: none;
            }
            .map-toolbar .btn .btn-text {
                display: none;
            }
        }

        /* Tree View Styles */
        .tree-view-container {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            margin: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tree-nav-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--primary);
            color: white;
        }

        .tree-back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .tree-back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tree-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            opacity: 0.7;
        }

        .breadcrumb-item.active {
            opacity: 1;
            font-weight: 600;
        }

        .breadcrumb-separator {
            opacity: 0.5;
        }

        .tree-content {
            padding: 0.5rem;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.35rem 0;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .tree-item:hover {
            background: var(--primary-light);
        }

        .tree-item:active {
            transform: scale(0.98);
        }

        .tree-item.has-pret {
            border-left: 4px solid var(--success);
        }

        .tree-item.has-incomplet {
            border-left: 4px solid var(--warning);
        }

        .tree-item.has-both {
            border-left: 4px solid;
            border-image: linear-gradient(to bottom, var(--success) 50%, var(--warning) 50%) 1;
        }

        .tree-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .tree-item-icon.zone {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tree-item-icon.subzone {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .tree-item-icon.kitting {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .tree-item-icon.kitting.pret {
            background: var(--success);
        }

        .tree-item-icon.kitting.incomplet {
            background: var(--warning);
        }

        .tree-item-content {
            flex: 1;
            min-width: 0;
        }

        .tree-item-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .tree-item-subtitle {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .tree-item-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tree-item-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tree-item-arrow {
            color: var(--text-light);
            margin-left: 0.5rem;
        }

        .tree-item-status {
            display: flex;
            gap: 0.35rem;
        }

        .tree-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .tree-status-dot.pret {
            background: var(--success);
        }

        .tree-status-dot.incomplet {
            background: var(--warning);
        }

        .tree-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .tree-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Kitting item in tree view */
        .tree-kitting-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.35rem 0;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tree-kitting-item:hover {
            background: var(--primary-light);
        }

        .tree-kitting-item.pret {
            background: #e8f5e9;
            border: 1px solid var(--success);
        }

        .tree-kitting-item.incomplet {
            background: #fff3e0;
            border: 1px solid var(--warning);
        }

        .tree-kitting-info {
            flex: 1;
        }

        .tree-kitting-ordre {
            font-weight: 600;
            font-size: 1rem;
        }

        .tree-kitting-pieces {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.2rem;
        }

        .tree-kitting-status {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tree-kitting-status.pret {
            background: var(--success);
            color: white;
        }

        .tree-kitting-status.incomplet {
            background: var(--warning);
            color: white;
        }

        /* Zone Config Modal */
        .zone-config {
            display: grid;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .zone-config-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 8px;
        }

        .zone-config-item input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .zone-config-item .color-picker {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .zone-config-item button {
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
        }

        /* Map Legend */
        .map-legend {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 8px;
            font-size: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.pret { background: var(--success); }
        .legend-dot.incomplet { background: var(--warning); }

        /* Edit mode toolbar */
        .edit-mode-banner {
            background: var(--secondary);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .edit-mode-banner.hidden {
            display: none;
        }

        /* Background image banner */
        .background-image-banner {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .background-image-banner.hidden {
            display: none;
        }

        /* Floor plan with background image */
        .floor-plan.has-background {
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .floor-plan.has-background .building-outline {
            display: none;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .header {
                padding: 1rem 2rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .kitting-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                padding: 1.5rem;
            }

            .stats {
                max-width: 600px;
                margin: 0 auto;
            }
        }

        @media (min-width: 1024px) {
            .kitting-list {
                grid-template-columns: repeat(3, 1fr);
                max-width: 1200px;
                margin: 0 auto;
            }

            .modal {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9v4H7v-4H3V9h4V5h2v4h4V5h2v4h4v2z"/>
            </svg>
            Suivi Kitting - Aciérie
        </h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openNewKittingModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Nouveau Kitting
            </button>
            <button class="btn btn-secondary" onclick="openScanModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5zM19 13h-1.5v1.5H19V13z"/>
                </svg>
                Scanner Étiquette
            </button>
        </div>
    </header>

    <!-- Page Liste -->
    <div class="page active" id="pageList">
        <!-- Search & Filters -->
        <section class="search-section">
            <input type="text" class="search-input" placeholder="Rechercher par n° d'ordre ou pièce..." id="searchInput" oninput="filterKittings()">
            <div class="filters">
                <button class="filter-btn active" data-status="all" onclick="setFilter('all')">Tous</button>
                <button class="filter-btn" data-status="pret" onclick="setFilter('pret')">Prêts</button>
                <button class="filter-btn" data-status="incomplet" onclick="setFilter('incomplet')">Incomplets</button>
            </div>
        </section>

        <!-- Stats -->
        <section class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Kittings</div>
            </div>
            <div class="stat-card pret">
                <div class="stat-number" id="pretCount">0</div>
                <div class="stat-label">Prêts</div>
            </div>
            <div class="stat-card incomplet">
                <div class="stat-number" id="incompletCount">0</div>
                <div class="stat-label">Incomplets</div>
            </div>
        </section>

        <!-- Kitting Lists by Status -->
        <div class="kitting-sections">
            <!-- Section Incomplets -->
            <section class="kitting-section">
                <div class="section-header incomplet">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Kittings Incomplets
                    </h3>
                    <span class="section-count" id="incompletSectionCount">0</span>
                </div>
                <div class="kitting-list" id="incompletList">
                    <!-- Incomplete cards will be inserted here -->
                </div>
            </section>

            <!-- Section Complets -->
            <section class="kitting-section">
                <div class="section-header pret">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        Kittings Prêts
                    </h3>
                    <span class="section-count" id="pretSectionCount">0</span>
                </div>
                <div class="kitting-list" id="pretList">
                    <!-- Complete cards will be inserted here -->
                </div>
            </section>
        </div>
    </div>

    <!-- Page Plan -->
    <div class="page" id="pageMap">
        <div class="map-container">
            <div class="map-header">
                <h2>Plan de Stockage</h2>
                <div class="map-toolbar">
                    <div class="zoom-controls">
                        <button class="btn btn-icon btn-secondary" onclick="zoomOut()" title="Dézoomer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13H5v-2h14v2z"/>
                            </svg>
                        </button>
                        <span class="zoom-level" id="zoomLevel">100%</span>
                        <button class="btn btn-icon btn-secondary" onclick="zoomIn()" title="Zoomer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="resetZoom()" title="Réinitialiser">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                            </svg>
                        </button>
                    </div>
                    <label class="btn btn-secondary" title="Ajouter une image de fond">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <span class="btn-text">Image</span>
                        <input type="file" accept="image/*" style="display: none;" onchange="handleBackgroundImage(event)">
                    </label>
                    <button class="btn btn-secondary" id="editModeBtn" onclick="toggleEditMode()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                        <span class="btn-text">Éditer</span>
                    </button>
                    <button class="btn btn-primary" onclick="openZoneConfigModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        <span class="btn-text">Zone</span>
                    </button>
                </div>
            </div>

            <div class="edit-mode-banner hidden" id="editModeBanner">
                <span>Mode édition - Déplacez et redimensionnez les zones</span>
                <button class="btn btn-outline" style="color: white; border-color: white; padding: 0.4rem 0.75rem;" onclick="toggleEditMode()">
                    Terminer
                </button>
            </div>

            <div class="background-image-banner hidden" id="bgImageBanner">
                <span>Image de fond chargée</span>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline" style="color: white; border-color: white; padding: 0.4rem 0.75rem;" onclick="adjustBackgroundImage()">
                        Ajuster
                    </button>
                    <button class="btn btn-outline" style="color: #ff6b6b; border-color: #ff6b6b; padding: 0.4rem 0.75rem;" onclick="removeBackgroundImage()">
                        Supprimer
                    </button>
                </div>
            </div>

            <!-- Vue Plan (Desktop) -->
            <div class="floor-plan-wrapper desktop-only">
                <div class="floor-plan" id="floorPlan">
                    <div class="floor-plan-inner" id="floorPlanInner">
                        <div class="building-outline">
                            <span class="building-label">Aciérie - Zone de Stockage</span>
                        </div>
                        <!-- Zones will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Vue Arborescente (Mobile) -->
            <div class="tree-view-container mobile-only" id="treeViewContainer">
                <div class="tree-nav-header" id="treeNavHeader">
                    <button class="tree-back-btn" id="treeBackBtn" onclick="treeNavigateBack()" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                    </button>
                    <div class="tree-breadcrumb" id="treeBreadcrumb">
                        <span class="breadcrumb-item active">Zones</span>
                    </div>
                </div>
                <div class="tree-content" id="treeContent">
                    <!-- Contenu arborescent généré dynamiquement -->
                </div>
            </div>

            <div class="map-legend desktop-only">
                <div class="legend-item">
                    <div class="legend-dot pret"></div>
                    <span>Prêt</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot incomplet"></div>
                    <span>Incomplet</span>
                </div>
                <div class="legend-item" style="margin-left: auto; color: var(--text-light);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    <span>Cliquez sur un kitting pour voir les détails</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showPage('pageList')" data-page="pageList">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
            Liste
        </button>
        <button class="nav-item" onclick="showPage('pageMap')" data-page="pageMap">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
            </svg>
            Plan
        </button>
        <button class="nav-item" onclick="openScanModal()">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5zM19 13h-1.5v1.5H19V13z"/>
            </svg>
            Scanner
        </button>
    </nav>

    <!-- FAB (hidden when on map page) -->
    <button class="fab" id="fabButton" onclick="openScanModal()" title="Scanner une étiquette">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 4C7.03 4 2.73 7.11 1 11.5 2.73 15.89 7.03 19 12 19s9.27-3.11 11-7.5C21.27 7.11 16.97 4 12 4zm0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>
    </button>

    <!-- New Kitting Modal -->
    <div class="modal-overlay" id="newKittingModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Nouveau Kitting</h2>
                <button class="modal-close" onclick="closeModal('newKittingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Numéro d'Ordre (OT) *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="newOrdre" placeholder="Ex: 123456" style="flex: 1;" oninput="checkOTForPieces()">
                        <button type="button" class="btn btn-secondary" id="btnLoadPieces" onclick="loadPiecesForOT()" title="Charger pièces depuis Arrêt Annuel" style="position: relative;">
                            📦
                            <span id="piecesBadge" style="display: none; position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #2e7d32; color: white; border-radius: 50%; font-size: 11px; font-weight: bold; line-height: 18px; text-align: center;">✓</span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="newDescription" placeholder="Description du kitting">
                </div>
                <div class="form-group">
                    <label class="form-label">Zone de Stockage *</label>
                    <select class="form-select" id="newLocation" onchange="updateSubZoneSelect()">
                        <option value="">-- Sélectionner une zone --</option>
                    </select>
                </div>
                <div class="form-group" id="subZoneGroup" style="display: none;">
                    <label class="form-label">Case / Étagère</label>
                    <select class="form-select" id="newSubZone">
                        <option value="">-- Aucune (zone générale) --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Pièces attendues</label>
                    <div id="piecesListContainer" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                        <div id="piecesList"></div>
                    </div>
                    <textarea class="form-input" id="newPieces" rows="4" placeholder="Ou saisir manuellement (une par ligne)"></textarea>
                    <div id="piecesCount" style="margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-light);"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('newKittingModal')">Annuler</button>
                <button class="btn btn-primary" onclick="createKitting()">Créer Kitting</button>
            </div>
        </div>
    </div>

    <!-- Scan Modal -->
    <div class="modal-overlay" id="scanModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Scanner Étiquette</h2>
                <button class="modal-close" onclick="closeScanModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="camera-section">
                    <div class="camera-preview" id="cameraPreview">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <img id="capturedImage" style="display: none;">
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-primary" id="captureBtn" onclick="capturePhoto()" style="flex: 1;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="8"/>
                            </svg>
                            Capturer
                        </button>
                        <button class="btn btn-secondary" id="retakeBtn" onclick="retakePhoto()" style="flex: 1; display: none;">
                            Reprendre
                        </button>
                        <label class="btn btn-secondary" style="flex: 1;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                            </svg>
                            Galerie
                            <input type="file" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        </label>
                    </div>
                </div>

                <div class="ocr-results" id="ocrResults" style="display: none;">
                    <h4>Texte détecté sur l'étiquette:</h4>
                    <div class="ocr-text" id="ocrText"></div>
                </div>

                <div class="form-group" id="kittingSelectGroup" style="display: none; margin-top: 1rem;">
                    <label class="form-label">Ajouter à quel kitting ?</label>
                    <select class="form-select" id="targetKitting">
                        <option value="">-- Sélectionner un kitting --</option>
                    </select>
                </div>

                <div class="form-group" id="pieceNameGroup" style="display: none;">
                    <label class="form-label">Nom de la pièce</label>
                    <input type="text" class="form-input" id="pieceName" placeholder="Nom de la pièce détectée">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeScanModal()">Annuler</button>
                <button class="btn btn-success" id="addPieceBtn" onclick="addScannedPiece()" style="display: none;">
                    Ajouter la pièce
                </button>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div class="detail-view" id="detailView">
        <div class="detail-inner">
            <div class="detail-header">
                <button class="back-btn" onclick="closeDetailView()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h2 id="detailTitle">Détail Kitting</h2>
            </div>
            <div class="detail-content">
                <div class="detail-actions">
                    <button class="btn btn-primary" onclick="openScanForCurrentKitting()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4C7.03 4 2.73 7.11 1 11.5 2.73 15.89 7.03 19 12 19s9.27-3.11 11-7.5C21.27 7.11 16.97 4 12 4z"/>
                        </svg>
                        Scanner Pièce
                    </button>
                    <button class="btn btn-secondary" onclick="openAddPieceManual()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Ajouter Pièce
                    </button>
                </div>

                <div class="detail-section info-section">
                    <h3>Informations</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">N° Ordre</span>
                            <span class="info-value" id="detailOrdre"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Description</span>
                            <span class="info-value" id="detailDescription"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Localisation</span>
                            <span class="info-value" id="detailLocation"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Statut</span>
                            <span class="info-value" id="detailStatus"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Créé le</span>
                            <span class="info-value" id="detailDate"></span>
                        </div>
                    </div>
                </div>

                <div class="detail-section pieces-section">
                    <h3>Pièces (<span id="detailPiecesCount">0</span>/<span id="detailTotalPieces">0</span>)</h3>
                    <ul class="piece-list" id="detailPieceList">
                        <!-- Pieces will be inserted here -->
                    </ul>
                </div>

                <div class="detail-section actions-section">
                    <h3>Actions</h3>
                    <div class="actions-grid">
                        <button class="btn btn-success" onclick="markKittingReady()" id="markReadyBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            Marquer Prêt
                        </button>
                        <button class="btn btn-outline" onclick="editKittingLocation()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            Modifier Zone
                        </button>
                        <button class="btn btn-danger" onclick="deleteKitting()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Piece Modal -->
    <div class="modal-overlay" id="addPieceModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Ajouter une Pièce</h2>
                <button class="modal-close" onclick="closeModal('addPieceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom de la pièce</label>
                    <input type="text" class="form-input" id="manualPieceName" placeholder="Nom de la pièce">
                </div>
                <div class="form-group">
                    <label class="form-label">Quantités</label>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.85rem; color: var(--text-light);">Requise</label>
                            <input type="number" class="form-input" id="manualPieceQtyRequired" value="1" min="1" step="1">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 0.85rem; color: var(--text-light);">Reçue</label>
                            <input type="number" class="form-input" id="manualPieceQtyReceived" value="0" min="0" step="1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addPieceModal')">Annuler</button>
                <button class="btn btn-primary" onclick="addManualPiece()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Zone Config Modal -->
    <div class="modal-overlay" id="zoneConfigModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Ajouter une Zone Générale</h2>
                <button class="modal-close" onclick="closeModal('zoneConfigModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom de la zone générale *</label>
                    <input type="text" class="form-input" id="newZoneName" placeholder="Ex: Zone A, Secteur Nord...">
                </div>
                <div class="form-group">
                    <label class="form-label">Dimensions (en pixels)</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" class="form-input" id="newZoneWidth" min="150" max="500" value="200" style="width: 100px;">
                        <span>x</span>
                        <input type="number" class="form-input" id="newZoneHeight" min="120" max="400" value="180" style="width: 100px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Sous-zones / Cases / Étagères</label>
                    <div id="newSubZonesList" style="margin-bottom: 0.5rem;"></div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="newSubZoneName" placeholder="Nom de la case/étagère" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="addSubZoneToNew()">+ Ajouter</button>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                        Les sous-zones permettent d'organiser les kittings à l'intérieur de la zone générale.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('zoneConfigModal')">Annuler</button>
                <button class="btn btn-primary" onclick="addNewZone()">Créer la Zone</button>
            </div>
        </div>
    </div>

    <!-- Edit Zone Modal -->
    <div class="modal-overlay" id="editZoneModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Modifier la Zone</h2>
                <button class="modal-close" onclick="closeModal('editZoneModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom de la zone générale</label>
                    <input type="text" class="form-input" id="editZoneName">
                </div>
                <div class="form-group">
                    <label class="form-label">Dimensions (pixels)</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" class="form-input" id="editZoneWidth" min="150" max="500" style="width: 100px;">
                        <span>x</span>
                        <input type="number" class="form-input" id="editZoneHeight" min="120" max="400" style="width: 100px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Sous-zones / Cases / Étagères</label>
                    <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.5rem;">
                        Cliquez sur le nom d'une sous-zone pour la renommer. Utilisez les flèches pour réordonner.
                    </p>
                    <div id="editSubZonesList" style="margin-bottom: 0.5rem; max-height: 200px; overflow-y: auto;"></div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="editSubZoneName" placeholder="Nouvelle case/étagère" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="addSubZoneToEdit()">+ Ajouter</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentZone()" style="margin-right: auto;">Supprimer Zone</button>
                <button class="btn btn-outline" onclick="closeModal('editZoneModal')">Annuler</button>
                <button class="btn btn-primary" onclick="saveEditedZone()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Edit Location Modal -->
    <div class="modal-overlay" id="editLocationModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Modifier la zone de stockage</h2>
                <button class="modal-close" onclick="closeModal('editLocationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Sélectionner la zone</label>
                    <select class="form-select" id="editLocationSelect" onchange="updateEditLocationSubZone()">
                        <option value="">-- Sélectionner une zone --</option>
                    </select>
                </div>
                <div class="form-group" id="editLocationSubZoneGroup" style="display: none;">
                    <label class="form-label">Case / Étagère</label>
                    <select class="form-select" id="editLocationSubZone">
                        <option value="">-- Aucune (zone générale) --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editLocationModal')">Annuler</button>
                <button class="btn btn-primary" onclick="saveNewLocation()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Background Image Settings Modal -->
    <div class="modal-overlay" id="bgImageModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Paramètres de l'image de fond</h2>
                <button class="modal-close" onclick="closeModal('bgImageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Mode d'affichage</label>
                    <select class="form-select" id="bgImageMode" onchange="updateBackgroundMode()">
                        <option value="contain">Contenir (image entière visible)</option>
                        <option value="cover">Couvrir (remplit tout l'espace)</option>
                        <option value="auto">Taille originale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Transparence des zones</label>
                    <input type="range" id="zoneTransparency" min="0" max="90" value="40"
                           style="width: 100%;" onchange="updateZoneTransparency()">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-light);">
                        <span>Opaque</span>
                        <span id="transparencyValue">40%</span>
                        <span>Transparent</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Dimensions du plan (pixels)</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" class="form-input" id="planWidth" min="400" max="2000" value="600" style="width: 100px;">
                        <span>x</span>
                        <input type="number" class="form-input" id="planHeight" min="300" max="1500" value="400" style="width: 100px;">
                        <button class="btn btn-secondary" onclick="applyPlanDimensions()" style="padding: 0.5rem 1rem;">Appliquer</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="removeBackgroundImage()">Supprimer l'image</button>
                <button class="btn btn-primary" onclick="closeModal('bgImageModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyA4bfAKvmgkw1DyTZSvcudndX7z7hUJWZU",
            authDomain: "kitting-acierie.firebaseapp.com",
            projectId: "kitting-acierie",
            storageBucket: "kitting-acierie.firebasestorage.app",
            messagingSenderId: "209681179346",
            appId: "1:209681179346:web:1d3f521c178a1910d2430b"
        };

        // Initialize Firebase (Kitting app)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Configuration Firebase pour Cath's Eyes (lecture des pièces)
        const cathsEyesConfig = {
            apiKey: "AIzaSyBI6F9YaMkxjIOzMpyjz3osrTklAMpIBZE",
            authDomain: "caths-eyes.firebaseapp.com",
            projectId: "caths-eyes",
            storageBucket: "caths-eyes.firebasestorage.app",
            messagingSenderId: "659756322626",
            appId: "1:659756322626:web:4163988910805ef7ec82db"
        };

        // Initialize secondary Firebase app for reading pieces
        const cathsEyesApp = firebase.initializeApp(cathsEyesConfig, 'cathsEyes');
        const cathsEyesDb = cathsEyesApp.firestore();

        // Data storage
        let kittings = [];
        let piecesFromCathsEyes = []; // Pièces importées depuis Cath's Eyes
        let currentFilter = 'all';
        let currentKittingId = null;
        let cameraStream = null;
        let currentPage = 'pageList';
        let isOnline = navigator.onLine;

        // Zone configuration with positions and sub-zones
        let zoneConfig = {
            zones: [
                {
                    id: 'zone-a', name: 'Zone A', x: 50, y: 50, width: 200, height: 180,
                    subZones: [
                        { id: 'zone-a-1', name: 'Case 1' },
                        { id: 'zone-a-2', name: 'Case 2' },
                        { id: 'zone-a-3', name: 'Case 3' }
                    ]
                },
                {
                    id: 'zone-b', name: 'Zone B', x: 270, y: 50, width: 200, height: 180,
                    subZones: [
                        { id: 'zone-b-1', name: 'Étagère 1' },
                        { id: 'zone-b-2', name: 'Étagère 2' }
                    ]
                },
                {
                    id: 'zone-c', name: 'Zone C', x: 490, y: 50, width: 200, height: 180,
                    subZones: []
                }
            ],
            backgroundImage: null,
            backgroundMode: 'contain',
            zoneTransparency: 40,
            planWidth: 750,
            planHeight: 450
        };
        let editMode = false;
        let editingZoneId = null;
        let dragState = null;
        let currentZoom = 100;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Listen for online/offline status
            window.addEventListener('online', () => { isOnline = true; showToast('Connexion rétablie'); });
            window.addEventListener('offline', () => { isOnline = false; showToast('Mode hors ligne'); });

            // Load zone config from localStorage (local setting)
            loadZoneConfig();

            // Setup real-time listeners for Firebase
            setupRealtimeListeners();

            // Charger les pièces depuis Cath's Eyes
            loadPiecesFromCathsEyes();

            renderKittings();
            updateStats();
            renderMap();
        });

        // ============================================
        // CATH'S EYES INTEGRATION - Chargement des pièces
        // ============================================

        async function loadPiecesFromCathsEyes() {
            try {
                // Les pièces sont stockées dans un document séparé 'pieces'
                const piecesDoc = await cathsEyesDb.collection('arretAnnuel').doc('pieces').get();

                if (piecesDoc.exists) {
                    const data = piecesDoc.data();
                    piecesFromCathsEyes = data.pieces || [];
                    console.log('Pièces chargées depuis Cath\'s Eyes:', piecesFromCathsEyes.length);
                    // Debug: afficher quelques exemples d'OT liés
                    if (piecesFromCathsEyes.length > 0) {
                        const otExemples = [...new Set(piecesFromCathsEyes.slice(0, 20).map(p => p.otLie))].filter(Boolean);
                        console.log('Exemples d\'OT liés:', otExemples);
                    }
                } else {
                    // Fallback: essayer l'ancien format (mainData)
                    const mainDoc = await cathsEyesDb.collection('arretAnnuel').doc('mainData').get();
                    if (mainDoc.exists) {
                        const data = mainDoc.data();
                        piecesFromCathsEyes = data.pieces || [];
                        console.log('Pièces chargées depuis mainData (ancien format):', piecesFromCathsEyes.length);
                    } else {
                        console.log('Aucune donnée trouvée dans Cath\'s Eyes Firebase');
                    }
                }
            } catch (error) {
                console.error('Erreur chargement pièces Cath\'s Eyes:', error);
            }
        }

        // Obtenir les pièces pour un OT spécifique
        function getPiecesForOT(otNumber) {
            if (!otNumber) return [];

            // Normaliser le numéro recherché (enlever espaces, tirets, mettre en minuscule)
            const normalizeOT = (ot) => {
                return (ot || '').toString().trim().toLowerCase()
                    .replace(/[-_\s]/g, '')  // Enlever tirets, underscores, espaces
                    .replace(/^0+/, '');      // Enlever les zéros au début
            };

            const searchOT = normalizeOT(otNumber);
            console.log('Recherche OT:', otNumber, '-> normalisé:', searchOT);
            console.log('Nombre de pièces disponibles:', piecesFromCathsEyes.length);

            const results = piecesFromCathsEyes.filter(p => {
                const pieceOT = normalizeOT(p.otLie);
                // Correspondance exacte ou partielle
                return pieceOT === searchOT ||
                       pieceOT.includes(searchOT) ||
                       searchOT.includes(pieceOT) ||
                       // Essayer aussi avec le champ 'ot' si otLie est vide
                       normalizeOT(p.ot) === searchOT ||
                       normalizeOT(p.ot).includes(searchOT);
            });

            console.log('Pièces trouvées:', results.length);
            return results;
        }

        // Formater les pièces pour le kitting
        // Utilise: OT Lié, Référence, Désignation
        function formatPiecesForKitting(pieces) {
            return pieces.map(p => {
                const ref = (p.reference || '').trim();
                const designation = (p.designation || '').trim();

                // Format: "Référence - Désignation" ou juste "Désignation" si pas de référence
                if (ref && designation) {
                    return `${ref} - ${designation}`;
                } else if (ref) {
                    return ref;
                } else if (designation) {
                    return designation;
                } else {
                    return 'Pièce sans description';
                }
            }).join('\n');
        }

        // Vérifier si l'OT a des pièces associées (appelé à chaque frappe)
        function checkOTForPieces() {
            const otNumber = document.getElementById('newOrdre').value.trim();
            const badge = document.getElementById('piecesBadge');

            if (otNumber.length < 2) {
                badge.style.display = 'none';
                return;
            }

            const pieces = getPiecesForOT(otNumber);
            if (pieces.length > 0) {
                badge.style.display = 'block';
                badge.textContent = pieces.length > 9 ? '9+' : pieces.length;
                badge.title = `${pieces.length} pièce(s) trouvée(s)`;
            } else {
                badge.style.display = 'none';
            }
        }

        // Variable pour stocker les pièces chargées
        let loadedPiecesForKitting = [];

        // Charger les pièces pour l'OT entré
        function loadPiecesForOT() {
            const otNumber = document.getElementById('newOrdre').value.trim();
            if (!otNumber) {
                showToast('Entrez d\'abord un numéro d\'OT');
                return;
            }

            const pieces = getPiecesForOT(otNumber);
            if (pieces.length === 0) {
                showToast('Aucune pièce trouvée pour cet OT');
                return;
            }

            // Stocker les pièces chargées
            loadedPiecesForKitting = pieces;

            // Afficher la liste avec checkboxes
            const container = document.getElementById('piecesListContainer');
            const list = document.getElementById('piecesList');

            list.innerHTML = pieces.map((p, index) => {
                const ref = (p.reference || '').trim();
                const designation = (p.designation || '').trim();
                const displayName = ref && designation ? `${ref} - ${designation}` : (ref || designation || 'Pièce sans nom');
                const quantite = parseFloat(p.quantite) || 1;

                return `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); gap: 10px; flex-wrap: wrap;">
                        <input type="checkbox" id="pieceReceived_${index}" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="pieceReceived_${index}" style="flex: 1; cursor: pointer; min-width: 150px;">${escapeHtml(displayName)}</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: var(--text-light); font-size: 0.8rem;">Qté requise: <strong>${quantite}</strong></span>
                            <span style="color: var(--text-light); font-size: 0.8rem; margin-left: 10px;">Reçue:</span>
                            <input type="number" id="pieceQtyReceived_${index}" min="0" step="1" value="0"
                                   style="width: 55px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; text-align: center;">
                        </div>
                    </div>
                `;
            }).join('');

            container.style.display = 'block';
            document.getElementById('newPieces').style.display = 'none';
            document.getElementById('piecesCount').innerHTML = `<span style="color: var(--success);">${pieces.length} pièce(s) - Cochez celles déjà reçues</span>`;

            showToast(`${pieces.length} pièce(s) chargée(s)`);
        }

        // ============================================
        // FIREBASE REAL-TIME SYNC
        // ============================================

        function setupRealtimeListeners() {
            // Listen to kittings collection in real-time
            db.collection('kittings').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                kittings = [];
                snapshot.forEach((doc) => {
                    kittings.push({ id: doc.id, ...doc.data() });
                });
                renderKittings();
                updateStats();
                renderMap();

                // Mettre à jour les notifications pour Cath's Eyes
                updateCathsEyesNotifications();

                // Update detail view if open
                if (currentKittingId) {
                    const kitting = kittings.find(k => k.id === currentKittingId);
                    if (kitting) {
                        renderDetailView(kitting);
                    }
                }
            }, (error) => {
                console.error("Erreur Firebase:", error);
                showToast('Erreur de connexion à la base de données');
                // Fallback to localStorage
                loadKittingsFromLocalStorage();
            });

            // Listen to zone config
            db.collection('config').doc('zones').onSnapshot((doc) => {
                if (doc.exists) {
                    zoneConfig = doc.data();
                    renderMap();
                }
            });
        }

        function loadKittingsFromLocalStorage() {
            const stored = localStorage.getItem('kittings');
            if (stored) {
                kittings = JSON.parse(stored);
                renderKittings();
                updateStats();
            }
        }

        // ============================================
        // FIREBASE CRUD OPERATIONS
        // ============================================

        async function saveKittingToFirebase(kitting) {
            try {
                if (kitting.id && kitting.id.length > 10) {
                    // Update existing
                    await db.collection('kittings').doc(kitting.id).set(kitting);
                } else {
                    // Create new
                    const docRef = await db.collection('kittings').add(kitting);
                    kitting.id = docRef.id;
                }
                // Mettre à jour les notifications Cath's Eyes
                await updateCathsEyesNotifications();
                return true;
            } catch (error) {
                console.error("Erreur sauvegarde:", error);
                showToast('Erreur de sauvegarde');
                return false;
            }
        }

        async function deleteKittingFromFirebase(kittingId) {
            try {
                await db.collection('kittings').doc(kittingId).delete();
                // Mettre à jour les notifications Cath's Eyes
                await updateCathsEyesNotifications();
                return true;
            } catch (error) {
                console.error("Erreur suppression:", error);
                showToast('Erreur de suppression');
                return false;
            }
        }

        // ============================================
        // NOTIFICATIONS CATH'S EYES
        // ============================================

        // Met à jour les stats de notification dans Cath's Eyes Firebase
        // pour que l'app principale affiche un badge sur le bouton Kitting
        async function updateCathsEyesNotifications() {
            try {
                // Calculer les totaux
                const totalKittings = kittings.length;
                const totalPieces = kittings.reduce((sum, k) => sum + (k.pieces ? k.pieces.length : 0), 0);

                // Écrire dans Cath's Eyes Firebase
                await cathsEyesDb.collection('kittingNotifications').doc('stats').set({
                    totalKittings: totalKittings,
                    totalPieces: totalPieces,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    lastKittingAdded: kittings.length > 0 ? kittings[0].ordre : null
                });

                console.log('Notifications Cath\'s Eyes mises à jour:', { totalKittings, totalPieces });
            } catch (error) {
                console.error('Erreur mise à jour notifications Cath\'s Eyes:', error);
            }
        }

        // Legacy functions for backward compatibility
        function saveKittings() {
            // No longer needed - Firebase handles sync
        }

        function loadKittings() {
            // No longer needed - Firebase handles sync via onSnapshot
        }

        // Render kittings list - separated by status
        function renderKittings() {
            const incompletList = document.getElementById('incompletList');
            const pretList = document.getElementById('pretList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = kittings.filter(k => {
                const matchesSearch = k.ordre.toLowerCase().includes(searchTerm) ||
                    k.description.toLowerCase().includes(searchTerm) ||
                    k.pieces.some(p => p.name.toLowerCase().includes(searchTerm));

                const matchesFilter = currentFilter === 'all' || k.status === currentFilter;

                return matchesSearch && matchesFilter;
            });

            // Séparer les kittings par statut
            const incomplets = filtered.filter(k => k.status === 'incomplet');
            const prets = filtered.filter(k => k.status === 'pret');

            // Mettre à jour les compteurs de section
            document.getElementById('incompletSectionCount').textContent = incomplets.length;
            document.getElementById('pretSectionCount').textContent = prets.length;

            // Fonction pour générer le HTML d'une carte
            function renderCard(k) {
                const receivedCount = k.pieces.filter(p => p.received).length;
                const totalCount = k.pieces.length;
                const progress = totalCount > 0 ? (receivedCount / totalCount * 100) : 0;

                return `
                    <div class="kitting-card ${k.status}" onclick="openDetailView('${k.id}')">
                        <div class="kitting-header">
                            <div class="kitting-ordre">${escapeHtml(k.ordre)}</div>
                            <span class="kitting-status ${k.status}">
                                ${k.status === 'pret' ? 'Prêt' : 'Incomplet'}
                            </span>
                        </div>
                        <div class="kitting-info">${escapeHtml(k.description) || 'Aucune description'}</div>
                        <div class="kitting-location">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            ${escapeHtml(k.location)}
                        </div>
                        <div class="kitting-pieces">
                            <div class="pieces-count">
                                <span>${receivedCount}/${totalCount} pièces</span>
                                <div class="pieces-bar">
                                    <div class="pieces-progress" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render incomplets
            if (incomplets.length === 0) {
                incompletList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <p>Aucun kitting incomplet</p>
                    </div>
                `;
            } else {
                incompletList.innerHTML = incomplets.map(renderCard).join('');
            }

            // Render prêts
            if (prets.length === 0) {
                pretList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <p>Aucun kitting prêt</p>
                    </div>
                `;
            } else {
                pretList.innerHTML = prets.map(renderCard).join('');
            }
        }

        // Update stats
        function updateStats() {
            const total = kittings.length;
            const pret = kittings.filter(k => k.status === 'pret').length;
            const incomplet = kittings.filter(k => k.status === 'incomplet').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pretCount').textContent = pret;
            document.getElementById('incompletCount').textContent = incomplet;
        }

        // Filter
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === filter);
            });
            renderKittings();
        }

        function filterKittings() {
            renderKittings();
        }

        // Modal helpers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // New Kitting
        function openNewKittingModal() {
            document.getElementById('newOrdre').value = '';
            document.getElementById('newDescription').value = '';
            document.getElementById('newPieces').value = '';

            // Reset liste des pièces chargées
            loadedPiecesForKitting = [];
            document.getElementById('piecesListContainer').style.display = 'none';
            document.getElementById('piecesList').innerHTML = '';
            document.getElementById('newPieces').style.display = 'block';
            document.getElementById('piecesCount').innerHTML = '';
            document.getElementById('piecesBadge').style.display = 'none';

            // Remplir le menu déroulant avec les zones de stockage existantes
            const locationSelect = document.getElementById('newLocation');
            locationSelect.innerHTML = '<option value="">-- Sélectionner une zone --</option>';

            zoneConfig.zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = zone.name;
                option.dataset.hasSubzones = (zone.subZones && zone.subZones.length > 0) ? 'true' : 'false';
                locationSelect.appendChild(option);
            });

            // Reset sub-zone select
            document.getElementById('subZoneGroup').style.display = 'none';
            document.getElementById('newSubZone').innerHTML = '<option value="">-- Aucune (zone générale) --</option>';

            openModal('newKittingModal');
        }

        function updateSubZoneSelect() {
            const locationSelect = document.getElementById('newLocation');
            const subZoneGroup = document.getElementById('subZoneGroup');
            const subZoneSelect = document.getElementById('newSubZone');
            const selectedZoneId = locationSelect.value;

            // Reset sub-zone select
            subZoneSelect.innerHTML = '<option value="">-- Aucune (zone générale) --</option>';

            if (!selectedZoneId) {
                subZoneGroup.style.display = 'none';
                return;
            }

            // Find the selected zone
            const zone = zoneConfig.zones.find(z => z.id === selectedZoneId);
            if (zone && zone.subZones && zone.subZones.length > 0) {
                zone.subZones.forEach(sz => {
                    const option = document.createElement('option');
                    option.value = sz.id;
                    option.textContent = sz.name;
                    subZoneSelect.appendChild(option);
                });
                subZoneGroup.style.display = 'block';
            } else {
                subZoneGroup.style.display = 'none';
            }
        }

        async function createKitting() {
            const ordre = document.getElementById('newOrdre').value.trim();
            const description = document.getElementById('newDescription').value.trim();
            const zoneId = document.getElementById('newLocation').value.trim();
            const subZoneId = document.getElementById('newSubZone').value.trim();
            const piecesText = document.getElementById('newPieces').value.trim();

            if (!ordre) {
                showToast('Le numéro d\'ordre est requis');
                return;
            }

            if (!zoneId) {
                showToast('La zone de stockage est requise');
                return;
            }

            // Build location string for display
            const zone = zoneConfig.zones.find(z => z.id === zoneId);
            let location = zone ? zone.name : zoneId;
            let subZoneName = null;

            if (subZoneId && zone && zone.subZones) {
                const subZone = zone.subZones.find(sz => sz.id === subZoneId);
                if (subZone) {
                    subZoneName = subZone.name;
                    location = `${zone.name} > ${subZone.name}`;
                }
            }

            let pieces = [];

            // Si des pièces ont été chargées depuis Arrêt Annuel
            if (loadedPiecesForKitting.length > 0) {
                pieces = loadedPiecesForKitting.map((p, index) => {
                    const ref = (p.reference || '').trim();
                    const designation = (p.designation || '').trim();
                    const name = ref && designation ? `${ref} - ${designation}` : (ref || designation || 'Pièce sans nom');

                    // Quantité requise depuis Arret Annuel
                    const quantityRequired = parseFloat(p.quantite) || 1;

                    // Quantité reçue saisie par l'utilisateur
                    const qtyInput = document.getElementById(`pieceQtyReceived_${index}`);
                    const quantityReceived = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;

                    // La pièce est reçue si quantité reçue >= quantité requise
                    const received = quantityReceived >= quantityRequired;

                    return {
                        id: generateId(),
                        name,
                        received,
                        quantityRequired,
                        quantityReceived
                    };
                });
            } else if (piecesText) {
                // Sinon utiliser le textarea (quantité par défaut = 1)
                pieces = piecesText
                    .split('\n')
                    .map(p => p.trim())
                    .filter(p => p)
                    .map(name => ({
                        id: generateId(),
                        name,
                        received: false,
                        quantityRequired: 1,
                        quantityReceived: 0
                    }));
            }

            // Déterminer le statut
            const allReceived = pieces.length > 0 && pieces.every(p => p.received);
            const status = allReceived ? 'pret' : 'incomplet';

            const kitting = {
                ordre,
                description,
                location,
                zoneId: zoneId,
                subZone: subZoneId || null,
                pieces,
                status,
                createdAt: new Date().toISOString()
            };

            // Save to Firebase
            const success = await saveKittingToFirebase(kitting);
            if (success) {
                // Reset
                loadedPiecesForKitting = [];
                document.getElementById('piecesListContainer').style.display = 'none';
                document.getElementById('newPieces').style.display = 'block';

                closeModal('newKittingModal');
                showToast('Kitting créé avec succès');
            }
        }

        // Scan Modal
        function openScanModal() {
            openModal('scanModal');
            startCamera();
            populateKittingSelect();
        }

        function closeScanModal() {
            stopCamera();
            document.getElementById('ocrResults').style.display = 'none';
            document.getElementById('kittingSelectGroup').style.display = 'none';
            document.getElementById('pieceNameGroup').style.display = 'none';
            document.getElementById('addPieceBtn').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'flex';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('cameraVideo').style.display = 'block';
            closeModal('scanModal');
        }

        function populateKittingSelect() {
            const select = document.getElementById('targetKitting');
            select.innerHTML = '<option value="">-- Sélectionner un kitting --</option>';

            kittings.filter(k => k.status === 'incomplet').forEach(k => {
                const option = document.createElement('option');
                option.value = k.id;
                option.textContent = `${k.ordre} - ${k.location}`;
                select.appendChild(option);
            });

            if (currentKittingId) {
                select.value = currentKittingId;
            }
        }

        // Camera
        async function startCamera() {
            try {
                const video = document.getElementById('cameraVideo');
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = cameraStream;
            } catch (err) {
                console.error('Camera error:', err);
                showToast('Impossible d\'accéder à la caméra. Utilisez la galerie.');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg');
            document.getElementById('capturedImage').src = imageData;
            document.getElementById('capturedImage').style.display = 'block';
            document.getElementById('cameraVideo').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'flex';

            stopCamera();
            processImage(imageData);
        }

        function retakePhoto() {
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('cameraVideo').style.display = 'block';
            document.getElementById('captureBtn').style.display = 'flex';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('ocrResults').style.display = 'none';
            document.getElementById('kittingSelectGroup').style.display = 'none';
            document.getElementById('pieceNameGroup').style.display = 'none';
            document.getElementById('addPieceBtn').style.display = 'none';
            startCamera();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    document.getElementById('capturedImage').src = imageData;
                    document.getElementById('capturedImage').style.display = 'block';
                    document.getElementById('cameraVideo').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'none';
                    document.getElementById('retakeBtn').style.display = 'flex';
                    stopCamera();
                    processImage(imageData);
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        // OCR Processing
        async function processImage(imageData) {
            showToast('Prétraitement de l\'image...');

            try {
                // Prétraiter l'image pour améliorer l'OCR
                const processedImage = await preprocessImage(imageData);

                showToast('Analyse de l\'étiquette en cours...');

                const result = await Tesseract.recognize(processedImage, 'fra', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:;,.-/ ',
                    tessedit_pageseg_mode: '6', // Assume uniform block of text
                    preserve_interword_spaces: '1',
                });

                const text = result.data.text.trim();
                document.getElementById('ocrText').textContent = text || 'Aucun texte détecté';
                document.getElementById('ocrResults').style.display = 'block';
                document.getElementById('kittingSelectGroup').style.display = 'block';
                document.getElementById('pieceNameGroup').style.display = 'block';
                document.getElementById('addPieceBtn').style.display = 'block';

                // Extraction intelligente des données de l'étiquette
                const extractedData = extractLabelData(text);

                // Afficher les données extraites
                displayExtractedData(extractedData);

                // Remplir automatiquement les champs
                if (extractedData.article && extractedData.description) {
                    document.getElementById('pieceName').value = `${extractedData.article} - ${extractedData.description}`;
                } else if (extractedData.article) {
                    document.getElementById('pieceName').value = extractedData.article;
                } else if (extractedData.articleFournisseur) {
                    document.getElementById('pieceName').value = extractedData.articleFournisseur;
                } else if (extractedData.description) {
                    document.getElementById('pieceName').value = extractedData.description;
                }

                showToast('Analyse terminée');
            } catch (err) {
                console.error('OCR error:', err);
                showToast('Erreur lors de l\'analyse');
                document.getElementById('kittingSelectGroup').style.display = 'block';
                document.getElementById('pieceNameGroup').style.display = 'block';
                document.getElementById('addPieceBtn').style.display = 'block';
            }
        }

        // Prétraitement de l'image pour améliorer l'OCR
        async function preprocessImage(imageData) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Agrandir l'image pour meilleure reconnaissance
                    const scale = 2;
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;

                    // Dessiner l'image agrandie
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Récupérer les données de l'image
                    const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageDataObj.data;

                    // Convertir en niveaux de gris et augmenter le contraste
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];

                        // Convertir en niveau de gris
                        let gray = 0.299 * r + 0.587 * g + 0.114 * b;

                        // Détecter le fond jaune et le rendre blanc
                        // Le jaune a R et G élevés, B bas
                        if (r > 180 && g > 180 && b < 150) {
                            gray = 255; // Fond jaune -> blanc
                        }

                        // Augmenter le contraste (binarisation avec seuil adaptatif)
                        // Texte noir sur fond clair
                        if (gray < 120) {
                            gray = 0; // Noir (texte)
                        } else {
                            gray = 255; // Blanc (fond)
                        }

                        data[i] = gray;
                        data[i + 1] = gray;
                        data[i + 2] = gray;
                    }

                    ctx.putImageData(imageDataObj, 0, 0);

                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = imageData;
            });
        }

        // Fonction d'extraction des données de l'étiquette
        function extractLabelData(text) {
            const data = {
                article: null,
                articleFournisseur: null,
                description: null,
                posteTechnique: null,
                quantite: null,
                date: null
            };

            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            console.log('=== OCR TEXT ===');
            console.log(text);
            console.log('=== LINES ===');
            lines.forEach((l, i) => console.log(i, ':', l));

            // ============================================
            // RECHERCHE ARTICLE et ARTICLE FOURNISSEUR
            // ============================================

            let articleLineIndex = -1;
            let articleFournisseurLineIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineLower = line.toLowerCase();

                // Détecter "Article Fournisseur" en premier (plus spécifique)
                if (lineLower.includes('fournisseur') ||
                    lineLower.includes('fourn') ||
                    lineLower.match(/article\s*f/i)) {

                    articleFournisseurLineIndex = i;

                    // Extraire la valeur après ":" si présente sur la même ligne
                    const afterColon = line.split(':')[1];
                    if (afterColon && afterColon.trim().length > 2) {
                        data.articleFournisseur = afterColon.trim();
                        console.log('Article Fournisseur (même ligne):', data.articleFournisseur);
                    }
                    // Sinon prendre la ligne suivante comme description fournisseur
                    else if (i + 1 < lines.length) {
                        const nextLine = lines[i + 1].trim();
                        if (nextLine && !isFieldLabel(nextLine)) {
                            data.articleFournisseur = nextLine;
                            console.log('Article Fournisseur (ligne suivante):', data.articleFournisseur);
                        }
                    }
                }
                // Détecter "Article" simple (sans "Fournisseur")
                else if ((lineLower.includes('article') ||
                          lineLower.includes('artlcle') ||
                          lineLower.includes('articie') ||
                          lineLower.match(/^art[il1]c/)) &&
                         !lineLower.includes('fournisseur') &&
                         !lineLower.includes('fourn')) {

                    articleLineIndex = i;

                    // Extraire le numéro d'article (7-8 chiffres)
                    const numbers = line.match(/\d{7,8}/g);
                    if (numbers && numbers.length > 0) {
                        data.article = numbers[0];
                        console.log('Article trouvé:', data.article);
                    }

                    // La description peut être sur plusieurs lignes après Article
                    // Collecter toutes les lignes jusqu'au prochain champ
                    let descriptionParts = [];
                    for (let j = i + 1; j < lines.length && j <= i + 3; j++) {
                        const nextLine = lines[j].trim();
                        if (nextLine && !isFieldLabel(nextLine)) {
                            descriptionParts.push(nextLine);
                        } else {
                            break; // Arrêter au premier champ rencontré
                        }
                    }

                    if (descriptionParts.length > 0) {
                        // Combiner les parties de description
                        data.description = cleanDescription(descriptionParts.join(' '));
                        console.log('Description (après Article, multi-lignes):', data.description);
                    }
                }
            }

            // ============================================
            // FALLBACK ARTICLE - Chercher numéro 8 chiffres
            // ============================================
            if (!data.article) {
                const allText = lines.join(' ');
                // Chercher numéro commençant par 2 (format courant)
                let numbers = allText.match(/\b2\d{7}\b/g);
                if (!numbers) {
                    numbers = allText.match(/\b\d{8}\b/g);
                }
                if (numbers && numbers.length > 0) {
                    data.article = numbers[0];
                    console.log('Article (fallback):', data.article);
                }
            }

            // ============================================
            // FALLBACK DESCRIPTION - Mots-clés industriels
            // ============================================
            if (!data.description) {
                // Liste étendue de mots-clés de pièces industrielles
                const keywords = /soupape|surete|sûreté|valve|joint|roulement|pompe|moteur|filtre|courroie|pignon|vis|ecrou|écrou|boulon|cylindre|piston|bague|ressort|axe|palier|engrenage|bride|manchon|tube|tuyau|cable|câble|capteur|verin|vérin|gaz|psi|hydraul|electr|relais|contact|interrup|connect|raccord|flang|rondelle|plate|plaque|goujon|tige|embout|coude|manchette|garniture|segment|chemise|clapet|distributeur|vanne|robinet|manometre|manomètre|thermostat|sonde|detecteur|détecteur|fusible|disjoncteur|contacteur|transformateur|condensateur|resistance|résistance|inductance|diode|transistor|led|lampe|ampoule|batterie|pile|chargeur|convertisseur|variateur|demarreur|démarreur|alternateur|dynamo|compresseur|ventilateur|radiateur|echangeur|échangeur|reservoir|réservoir|cuve|bonbonne|flexible|durite|collier|serflex|graisseur|lubrificateur|maneton|bielle|vilebrequin|arbre|came|culbuteur|soupape|injecteur|gicleur|carburateur|allumeur|bobine|bougie|faisceau|connectique|prise|fiche|douille|interrupteur|commutateur|selecteur|sélecteur|potentiometre|potentiomètre|encodeur|codeur/i;

                for (const line of lines) {
                    if (keywords.test(line) && !isFieldLabel(line)) {
                        data.description = cleanDescription(line);
                        console.log('Description (mots-clés):', data.description);
                        break;
                    }
                }
            }

            // ============================================
            // FALLBACK DESCRIPTION - Pattern technique (MM, dimensions)
            // ============================================
            if (!data.description) {
                // Chercher des lignes avec des patterns techniques (dimensions, références)
                for (const line of lines) {
                    // Pattern: contient des dimensions comme "M12", "24MM", "125A", etc.
                    if (line.match(/\d+\s*mm|\bm\d+\b|\d+x\d+|\d+[a-z]*:\d+/i) && !isFieldLabel(line)) {
                        data.description = cleanDescription(line);
                        console.log('Description (pattern technique):', data.description);
                        break;
                    }
                }
            }

            // ============================================
            // AUTRES CHAMPS
            // ============================================
            for (const line of lines) {
                const lineLower = line.toLowerCase();

                // Poste technique
                if (!data.posteTechnique && lineLower.includes('poste') && lineLower.includes('tech')) {
                    const match = line.match(/tech[a-z]*\s*[:\s]+(.+)/i);
                    if (match) {
                        data.posteTechnique = match[1].trim();
                    }
                }

                // Quantité
                if (!data.quantite && (lineLower.includes('qte') || lineLower.includes('qté') || lineLower.includes('sortie'))) {
                    const match = line.match(/(\d+[,.]?\d*)\s*(cha|pce|pcs|kg|m|l|ea|un)?/i);
                    if (match) {
                        data.quantite = match[1] + (match[2] ? ' ' + match[2].toUpperCase() : '');
                    }
                }

                // Date (format XX.XX.XXXX ou XX/XX/XXXX)
                if (!data.date) {
                    const dateMatch = line.match(/(\d{2}[\.\/\-]\d{2}[\.\/\-]\d{4})/);
                    if (dateMatch) {
                        data.date = dateMatch[1];
                    }
                }
            }

            console.log('=== EXTRACTED DATA ===', data);
            return data;
        }

        // Vérifie si une ligne est un label de champ (contient ":" avec un mot-clé)
        function isFieldLabel(line) {
            const fieldKeywords = /^(lot|qte|qté|compte|poste|division|point|date|magasin|réception|revision|code|sdi|article)/i;
            return fieldKeywords.test(line.trim()) ||
                   (line.includes(':') && line.indexOf(':') < 20);
        }

        // Nettoie la description des caractères parasites
        function cleanDescription(text) {
            return text
                .replace(/^[\s:;,.\-]+/, '')  // Enlever ponctuation au début
                .replace(/[\s:;,.\-]+$/, '')  // Enlever ponctuation à la fin
                .replace(/\s+/g, ' ')          // Normaliser les espaces
                .trim();
        }

        // Afficher les données extraites de manière formatée
        function displayExtractedData(data) {
            let html = '<div class="extracted-data">';
            html += '<h4 style="margin-bottom: 0.75rem; color: var(--primary);">Données extraites :</h4>';

            if (data.article) {
                html += `<p><strong>Article :</strong> <span class="extracted-value">${escapeHtml(data.article)}</span></p>`;
            }
            if (data.articleFournisseur) {
                html += `<p><strong>Article Fournisseur :</strong> <span class="extracted-value">${escapeHtml(data.articleFournisseur)}</span></p>`;
            }
            if (data.description) {
                html += `<p><strong>Description :</strong> <span class="extracted-value">${escapeHtml(data.description)}</span></p>`;
            }
            if (data.posteTechnique) {
                html += `<p><strong>Poste technique :</strong> <span class="extracted-value">${escapeHtml(data.posteTechnique)}</span></p>`;
            }
            if (data.quantite) {
                html += `<p><strong>Quantité :</strong> <span class="extracted-value">${escapeHtml(data.quantite)}</span></p>`;
            }
            if (data.date) {
                html += `<p><strong>Date :</strong> <span class="extracted-value">${escapeHtml(data.date)}</span></p>`;
            }

            // Si aucune donnée extraite
            if (!data.article && !data.articleFournisseur && !data.description) {
                html += '<p style="color: var(--warning);">Aucune donnée structurée détectée. Vérifiez le texte brut ci-dessous.</p>';
            }

            html += '</div>';

            // Insérer avant le texte OCR brut
            const ocrResults = document.getElementById('ocrResults');
            const existingExtracted = ocrResults.querySelector('.extracted-data');
            if (existingExtracted) {
                existingExtracted.remove();
            }
            ocrResults.insertAdjacentHTML('afterbegin', html);

            // Stocker les données pour utilisation ultérieure
            window.lastExtractedData = data;
        }

        async function addScannedPiece() {
            const kittingId = document.getElementById('targetKitting').value;
            const pieceName = document.getElementById('pieceName').value.trim();

            if (!kittingId) {
                showToast('Veuillez sélectionner un kitting');
                return;
            }

            if (!pieceName) {
                showToast('Veuillez entrer le nom de la pièce');
                return;
            }

            // Extraire la quantité depuis les données OCR si disponible
            const extractedQty = (window.lastExtractedData && window.lastExtractedData.quantite)
                ? parseFloat(window.lastExtractedData.quantite) || 1
                : 1;

            const kitting = kittings.find(k => k.id === kittingId);
            if (kitting) {
                // Check if piece already exists
                const existingPiece = kitting.pieces.find(
                    p => p.name.toLowerCase() === pieceName.toLowerCase()
                );

                if (existingPiece) {
                    // Incrémenter la quantité reçue
                    existingPiece.quantityReceived = (existingPiece.quantityReceived || 0) + extractedQty;
                    const qtyRequired = existingPiece.quantityRequired || 1;
                    existingPiece.received = existingPiece.quantityReceived >= qtyRequired;
                    showToast(`Quantité mise à jour: ${existingPiece.quantityReceived}/${qtyRequired}`);
                } else {
                    kitting.pieces.push({
                        id: generateId(),
                        name: pieceName,
                        received: true,
                        quantityRequired: 1,
                        quantityReceived: extractedQty
                    });
                    showToast('Pièce ajoutée au kitting');
                }

                // Update status if all pieces received
                const allReceived = kitting.pieces.every(p => p.received);
                kitting.status = allReceived && kitting.pieces.length > 0 ? 'pret' : 'incomplet';

                await saveKittingToFirebase(kitting);
            }

            closeScanModal();
        }

        // Detail View
        function openDetailView(id) {
            currentKittingId = id;
            const kitting = kittings.find(k => k.id === id);
            if (!kitting) return;

            renderDetailView(kitting);
            document.getElementById('detailView').classList.add('active');
        }

        function renderDetailView(kitting) {
            document.getElementById('detailTitle').textContent = kitting.ordre;
            document.getElementById('detailOrdre').textContent = kitting.ordre;
            document.getElementById('detailDescription').textContent = kitting.description || 'Aucune description';
            document.getElementById('detailLocation').textContent = kitting.location;
            document.getElementById('detailStatus').textContent = kitting.status === 'pret' ? 'Prêt' : 'Incomplet';
            document.getElementById('detailDate').textContent = new Date(kitting.createdAt).toLocaleDateString('fr-FR');

            const receivedCount = kitting.pieces.filter(p => p.received).length;
            document.getElementById('detailPiecesCount').textContent = receivedCount;
            document.getElementById('detailTotalPieces').textContent = kitting.pieces.length;

            const markReadyBtn = document.getElementById('markReadyBtn');
            if (kitting.status === 'pret') {
                markReadyBtn.textContent = 'Marquer comme Incomplet';
                markReadyBtn.classList.remove('btn-success');
                markReadyBtn.classList.add('btn-warning');
            } else {
                markReadyBtn.textContent = 'Marquer comme Prêt';
                markReadyBtn.classList.add('btn-success');
                markReadyBtn.classList.remove('btn-warning');
            }

            const pieceList = document.getElementById('detailPieceList');
            pieceList.innerHTML = kitting.pieces.map(p => {
                const qtyRequired = p.quantityRequired || 1;
                const qtyReceived = p.quantityReceived || 0;
                const isComplete = p.received || (qtyReceived >= qtyRequired);

                return `
                <li class="piece-item ${isComplete ? 'received' : ''}">
                    <input type="checkbox" class="piece-checkbox"
                           ${isComplete ? 'checked' : ''}
                           onchange="togglePieceReceived('${kitting.id}', '${p.id}', this.checked)">
                    <span class="piece-name">${escapeHtml(p.name)}</span>
                    <div class="piece-quantity">
                        <span class="piece-quantity-display ${isComplete ? 'complete' : 'incomplete'}">
                            ${qtyReceived}/${qtyRequired}
                        </span>
                        <input type="number" class="piece-quantity-input"
                               value="${qtyReceived}"
                               min="0"
                               step="1"
                               data-piece-id="${p.id}"
                               data-kitting-id="${kitting.id}"
                               onchange="updatePieceQuantity('${kitting.id}', '${p.id}', this.value)">
                    </div>
                    <button class="piece-remove" onclick="removePiece('${kitting.id}', '${p.id}')" title="Supprimer">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </li>
            `}).join('');

            if (kitting.pieces.length === 0) {
                pieceList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--text-light);">Aucune pièce dans ce kitting</li>';
            }
        }

        function closeDetailView() {
            document.getElementById('detailView').classList.remove('active');
            currentKittingId = null;
        }

        async function togglePiece(kittingId, pieceId) {
            const kitting = kittings.find(k => k.id === kittingId);
            if (!kitting) return;

            const piece = kitting.pieces.find(p => p.id === pieceId);
            if (piece) {
                piece.received = !piece.received;

                // Auto-update status
                const allReceived = kitting.pieces.every(p => p.received);
                kitting.status = allReceived && kitting.pieces.length > 0 ? 'pret' : 'incomplet';

                await saveKittingToFirebase(kitting);
            }
        }

        // Fonction pour cocher/décocher une pièce via checkbox
        async function togglePieceReceived(kittingId, pieceId, isChecked) {
            const kitting = kittings.find(k => k.id === kittingId);
            if (!kitting) return;

            const piece = kitting.pieces.find(p => p.id === pieceId);
            if (piece) {
                piece.received = isChecked;

                // Si coché manuellement, mettre la quantité reçue = quantité requise
                if (isChecked) {
                    piece.quantityReceived = piece.quantityRequired || 1;
                } else {
                    piece.quantityReceived = 0;
                }

                // Auto-update kitting status
                const allReceived = kitting.pieces.every(p => p.received);
                kitting.status = allReceived && kitting.pieces.length > 0 ? 'pret' : 'incomplet';

                await saveKittingToFirebase(kitting);
                showToast(isChecked ? 'Pièce reçue ✓' : 'Pièce non reçue');
            }
        }

        // Fonction pour mettre à jour la quantité reçue d'une pièce
        async function updatePieceQuantity(kittingId, pieceId, newQuantity) {
            const kitting = kittings.find(k => k.id === kittingId);
            if (!kitting) return;

            const piece = kitting.pieces.find(p => p.id === pieceId);
            if (piece) {
                const qty = parseFloat(newQuantity) || 0;
                piece.quantityReceived = qty;

                // Mettre à jour le statut "received" basé sur la quantité
                const qtyRequired = piece.quantityRequired || 1;
                piece.received = qty >= qtyRequired;

                // Auto-update kitting status
                const allReceived = kitting.pieces.every(p => p.received);
                kitting.status = allReceived && kitting.pieces.length > 0 ? 'pret' : 'incomplet';

                await saveKittingToFirebase(kitting);
                showToast(`Quantité mise à jour: ${qty}/${qtyRequired}`);
            }
        }

        async function removePiece(kittingId, pieceId) {
            const kitting = kittings.find(k => k.id === kittingId);
            if (!kitting) return;

            kitting.pieces = kitting.pieces.filter(p => p.id !== pieceId);

            // Auto-update status
            const allReceived = kitting.pieces.every(p => p.received);
            kitting.status = allReceived && kitting.pieces.length > 0 ? 'pret' : 'incomplet';

            await saveKittingToFirebase(kitting);
            showToast('Pièce supprimée');
        }

        function openScanForCurrentKitting() {
            openScanModal();
            document.getElementById('targetKitting').value = currentKittingId;
        }

        function openAddPieceManual() {
            document.getElementById('manualPieceName').value = '';
            document.getElementById('manualPieceQtyRequired').value = '1';
            document.getElementById('manualPieceQtyReceived').value = '0';
            openModal('addPieceModal');
        }

        async function addManualPiece() {
            const pieceName = document.getElementById('manualPieceName').value.trim();
            if (!pieceName) {
                showToast('Veuillez entrer le nom de la pièce');
                return;
            }

            const quantityRequired = parseFloat(document.getElementById('manualPieceQtyRequired').value) || 1;
            const quantityReceived = parseFloat(document.getElementById('manualPieceQtyReceived').value) || 0;
            const received = quantityReceived >= quantityRequired;

            const kitting = kittings.find(k => k.id === currentKittingId);
            if (kitting) {
                kitting.pieces.push({
                    id: generateId(),
                    name: pieceName,
                    received: received,
                    quantityRequired: quantityRequired,
                    quantityReceived: quantityReceived
                });

                // Auto-update kitting status
                const allReceived = kitting.pieces.every(p => p.received);
                kitting.status = allReceived && kitting.pieces.length > 0 ? 'pret' : 'incomplet';

                await saveKittingToFirebase(kitting);
                showToast('Pièce ajoutée');
            }

            closeModal('addPieceModal');
        }

        async function markKittingReady() {
            const kitting = kittings.find(k => k.id === currentKittingId);
            if (kitting) {
                kitting.status = kitting.status === 'pret' ? 'incomplet' : 'pret';
                await saveKittingToFirebase(kitting);
                showToast(`Kitting marqué comme ${kitting.status === 'pret' ? 'prêt' : 'incomplet'}`);
            }
        }

        async function editKittingLocation() {
            const kitting = kittings.find(k => k.id === currentKittingId);
            if (!kitting) return;

            // Remplir le menu déroulant avec les zones
            const select = document.getElementById('editLocationSelect');
            select.innerHTML = '<option value="">-- Sélectionner une zone --</option>';

            zoneConfig.zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = zone.name;
                // Select current zone
                if (kitting.zoneId === zone.id || kitting.location.toLowerCase().includes(zone.name.toLowerCase())) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Update sub-zone select after populating zones
            updateEditLocationSubZone();

            // Pre-select current sub-zone if exists
            if (kitting.subZone) {
                document.getElementById('editLocationSubZone').value = kitting.subZone;
            }

            openModal('editLocationModal');
        }

        function updateEditLocationSubZone() {
            const zoneSelect = document.getElementById('editLocationSelect');
            const subZoneGroup = document.getElementById('editLocationSubZoneGroup');
            const subZoneSelect = document.getElementById('editLocationSubZone');
            const selectedZoneId = zoneSelect.value;

            subZoneSelect.innerHTML = '<option value="">-- Aucune (zone générale) --</option>';

            if (!selectedZoneId) {
                subZoneGroup.style.display = 'none';
                return;
            }

            const zone = zoneConfig.zones.find(z => z.id === selectedZoneId);
            if (zone && zone.subZones && zone.subZones.length > 0) {
                zone.subZones.forEach(sz => {
                    const option = document.createElement('option');
                    option.value = sz.id;
                    option.textContent = sz.name;
                    subZoneSelect.appendChild(option);
                });
                subZoneGroup.style.display = 'block';
            } else {
                subZoneGroup.style.display = 'none';
            }
        }

        async function saveNewLocation() {
            const zoneId = document.getElementById('editLocationSelect').value;
            const subZoneId = document.getElementById('editLocationSubZone').value;

            if (!zoneId) {
                showToast('Veuillez sélectionner une zone');
                return;
            }

            const kitting = kittings.find(k => k.id === currentKittingId);
            if (kitting) {
                const zone = zoneConfig.zones.find(z => z.id === zoneId);
                let location = zone ? zone.name : zoneId;

                if (subZoneId && zone && zone.subZones) {
                    const subZone = zone.subZones.find(sz => sz.id === subZoneId);
                    if (subZone) {
                        location = `${zone.name} > ${subZone.name}`;
                    }
                }

                kitting.location = location;
                kitting.zoneId = zoneId;
                kitting.subZone = subZoneId || null;

                await saveKittingToFirebase(kitting);
                renderDetailView(kitting);
                showToast('Localisation mise à jour');
            }

            closeModal('editLocationModal');
        }

        async function deleteKitting() {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce kitting ?')) {
                await deleteKittingFromFirebase(currentKittingId);
                closeDetailView();
                showToast('Kitting supprimé');
            }
        }

        // Utilities
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ============================================
        // PAGE NAVIGATION
        // ============================================

        function showPage(pageId) {
            currentPage = pageId;

            // Update pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.toggle('active', page.id === pageId);
            });

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === pageId);
            });

            // Show/hide FAB
            const fab = document.getElementById('fabButton');
            if (fab) {
                fab.style.display = pageId === 'pageList' ? 'flex' : 'none';
            }

            // Render map when switching to map page
            if (pageId === 'pageMap') {
                renderMap();
            }
        }

        // ============================================
        // ZONE CONFIGURATION
        // ============================================

        function loadZoneConfig() {
            const stored = localStorage.getItem('zoneConfig');
            if (stored) {
                zoneConfig = JSON.parse(stored);
            }
        }

        function saveZoneConfigToStorage() {
            localStorage.setItem('zoneConfig', JSON.stringify(zoneConfig));
            // Also save to Firebase for sync across devices
            db.collection('config').doc('zones').set(zoneConfig).catch(err => {
                console.error('Erreur sauvegarde zones:', err);
            });
        }

        // Temporary storage for sub-zones during modal editing
        let tempNewSubZones = [];
        let tempEditSubZones = [];

        function openZoneConfigModal() {
            document.getElementById('newZoneName').value = '';
            document.getElementById('newZoneWidth').value = 200;
            document.getElementById('newZoneHeight').value = 180;
            document.getElementById('newSubZoneName').value = '';
            tempNewSubZones = [];
            renderNewSubZonesList();
            openModal('zoneConfigModal');
        }

        function addSubZoneToNew() {
            const name = document.getElementById('newSubZoneName').value.trim();
            if (!name) {
                showToast('Entrez un nom pour la sous-zone');
                return;
            }
            tempNewSubZones.push({ id: 'sz-' + Date.now(), name: name });
            document.getElementById('newSubZoneName').value = '';
            renderNewSubZonesList();
        }

        function removeNewSubZone(index) {
            tempNewSubZones.splice(index, 1);
            renderNewSubZonesList();
        }

        function renderNewSubZonesList() {
            const container = document.getElementById('newSubZonesList');
            if (tempNewSubZones.length === 0) {
                container.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-light); font-style: italic;">Aucune sous-zone ajoutée</p>';
                return;
            }
            container.innerHTML = tempNewSubZones.map((sz, i) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: var(--bg); border-radius: 4px; margin-bottom: 0.25rem;">
                    <span style="flex: 1;">${escapeHtml(sz.name)}</span>
                    <button type="button" class="btn btn-outline" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; color: var(--danger);" onclick="removeNewSubZone(${i})">×</button>
                </div>
            `).join('');
        }

        function addNewZone() {
            const name = document.getElementById('newZoneName').value.trim();
            const width = parseInt(document.getElementById('newZoneWidth').value) || 200;
            const height = parseInt(document.getElementById('newZoneHeight').value) || 180;

            if (!name) {
                showToast('Veuillez entrer un nom pour la zone');
                return;
            }

            const newZone = {
                id: 'zone-' + Date.now(),
                name: name,
                x: 200,
                y: 150,
                width: width,
                height: height,
                subZones: tempNewSubZones.map(sz => ({ id: sz.id, name: sz.name }))
            };

            zoneConfig.zones.push(newZone);
            saveZoneConfigToStorage();
            renderMap();
            closeModal('zoneConfigModal');
            showToast('Zone ajoutée avec ' + tempNewSubZones.length + ' sous-zone(s)');
        }

        function openEditZoneModal(zoneId) {
            const zone = zoneConfig.zones.find(z => z.id === zoneId);
            if (!zone) return;

            editingZoneId = zoneId;
            document.getElementById('editZoneName').value = zone.name;
            document.getElementById('editZoneWidth').value = zone.width || 200;
            document.getElementById('editZoneHeight').value = zone.height || 180;
            document.getElementById('editSubZoneName').value = '';
            tempEditSubZones = (zone.subZones || []).map(sz => ({ ...sz }));
            renderEditSubZonesList();
            openModal('editZoneModal');
        }

        function addSubZoneToEdit() {
            const name = document.getElementById('editSubZoneName').value.trim();
            if (!name) {
                showToast('Entrez un nom pour la sous-zone');
                return;
            }
            tempEditSubZones.push({ id: 'sz-' + Date.now(), name: name });
            document.getElementById('editSubZoneName').value = '';
            renderEditSubZonesList();
        }

        function removeEditSubZone(index) {
            tempEditSubZones.splice(index, 1);
            renderEditSubZonesList();
        }

        function renderEditSubZonesList() {
            const container = document.getElementById('editSubZonesList');
            if (tempEditSubZones.length === 0) {
                container.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-light); font-style: italic;">Aucune sous-zone</p>';
                return;
            }
            container.innerHTML = tempEditSubZones.map((sz, i) => `
                <div class="subzone-edit-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg); border-radius: 6px; margin-bottom: 0.35rem; border: 1px solid var(--border);">
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <button type="button" class="btn-arrow" onclick="moveSubZone(${i}, -1)" ${i === 0 ? 'disabled' : ''} title="Monter">▲</button>
                        <button type="button" class="btn-arrow" onclick="moveSubZone(${i}, 1)" ${i === tempEditSubZones.length - 1 ? 'disabled' : ''} title="Descendre">▼</button>
                    </div>
                    <input type="text" class="form-input subzone-name-input" value="${escapeHtml(sz.name)}"
                           onchange="renameSubZone(${i}, this.value)"
                           style="flex: 1; padding: 0.4rem; font-size: 0.9rem;">
                    <span class="subzone-kitting-count" style="font-size: 0.75rem; color: var(--text-light); min-width: 60px; text-align: center;">
                        ${getSubZoneKittingCount(sz.id)} kitting(s)
                    </span>
                    <button type="button" class="btn btn-outline btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.85rem; color: var(--danger);" onclick="removeEditSubZone(${i})" title="Supprimer">×</button>
                </div>
            `).join('');
        }

        function renameSubZone(index, newName) {
            if (newName.trim()) {
                tempEditSubZones[index].name = newName.trim();
            }
        }

        function moveSubZone(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= tempEditSubZones.length) return;

            const temp = tempEditSubZones[index];
            tempEditSubZones[index] = tempEditSubZones[newIndex];
            tempEditSubZones[newIndex] = temp;
            renderEditSubZonesList();
        }

        function getSubZoneKittingCount(subZoneId) {
            return kittings.filter(k => k.subZoneId === subZoneId).length;
        }

        function saveEditedZone() {
            const zone = zoneConfig.zones.find(z => z.id === editingZoneId);
            if (!zone) return;

            zone.name = document.getElementById('editZoneName').value.trim() || zone.name;
            zone.width = parseInt(document.getElementById('editZoneWidth').value) || zone.width;
            zone.height = parseInt(document.getElementById('editZoneHeight').value) || zone.height;
            zone.subZones = tempEditSubZones.map(sz => ({ id: sz.id, name: sz.name }));
            saveZoneConfigToStorage();
            renderMap();
            closeModal('editZoneModal');
            showToast('Zone modifiée avec ' + zone.subZones.length + ' sous-zone(s)');
        }

        function deleteCurrentZone() {
            if (confirm('Supprimer cette zone ?')) {
                zoneConfig.zones = zoneConfig.zones.filter(z => z.id !== editingZoneId);
                saveZoneConfigToStorage();
                renderMap();
                closeModal('editZoneModal');
                showToast('Zone supprimée');
            }
        }

        // ============================================
        // EDIT MODE (Drag & Resize)
        // ============================================

        function toggleEditMode() {
            editMode = !editMode;
            const banner = document.getElementById('editModeBanner');
            const btn = document.getElementById('editModeBtn');

            if (editMode) {
                banner.classList.remove('hidden');
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    Terminer
                `;
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
            } else {
                banner.classList.add('hidden');
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Éditer
                `;
                btn.classList.add('btn-secondary');
                btn.classList.remove('btn-success');
                saveZoneConfigToStorage();
            }

            renderMap();
        }

        function initDrag(e, zoneId, type) {
            if (!editMode) return;
            e.preventDefault();
            e.stopPropagation();

            const zone = zoneConfig.zones.find(z => z.id === zoneId);
            if (!zone) return;

            const floorPlan = document.getElementById('floorPlan');
            const rect = floorPlan.getBoundingClientRect();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            dragState = {
                zoneId: zoneId,
                type: type, // 'move' or 'resize'
                startX: clientX,
                startY: clientY,
                origX: zone.x,
                origY: zone.y,
                origWidth: zone.width,
                origHeight: zone.height,
                scrollLeft: floorPlan.scrollLeft,
                scrollTop: floorPlan.scrollTop
            };

            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', handleDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        function handleDrag(e) {
            if (!dragState) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const deltaX = clientX - dragState.startX;
            const deltaY = clientY - dragState.startY;

            const zone = zoneConfig.zones.find(z => z.id === dragState.zoneId);
            if (!zone) return;

            if (dragState.type === 'move') {
                zone.x = Math.max(10, dragState.origX + deltaX);
                zone.y = Math.max(10, dragState.origY + deltaY);
            } else if (dragState.type === 'resize') {
                zone.width = Math.max(100, dragState.origWidth + deltaX);
                zone.height = Math.max(80, dragState.origHeight + deltaY);
            }

            renderMap();
        }

        function endDrag() {
            if (dragState) {
                saveZoneConfigToStorage();
                dragState = null;
            }
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', handleDrag);
            document.removeEventListener('touchend', endDrag);
        }

        // ============================================
        // TREE VIEW (Mobile Navigation)
        // ============================================

        let treeNavState = {
            level: 'zones', // 'zones', 'subzones', 'kittings'
            currentZone: null,
            currentSubZone: null
        };

        function renderTreeView() {
            const container = document.getElementById('treeContent');
            const breadcrumb = document.getElementById('treeBreadcrumb');
            const backBtn = document.getElementById('treeBackBtn');

            if (!container) return;

            const kittingsByLocation = groupKittingsByLocation();

            if (treeNavState.level === 'zones') {
                // Niveau 1 : Liste des zones
                backBtn.style.display = 'none';
                breadcrumb.innerHTML = '<span class="breadcrumb-item active">Zones de stockage</span>';

                if (zoneConfig.zones.length === 0) {
                    container.innerHTML = `
                        <div class="tree-empty">
                            <div class="tree-empty-icon">📦</div>
                            <p>Aucune zone configurée</p>
                            <button class="btn btn-primary" onclick="openZoneConfigModal()" style="margin-top: 1rem;">
                                + Ajouter une zone
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = zoneConfig.zones.map(zone => {
                    const zoneData = kittingsByLocation[zone.id] || { direct: [], subZones: {} };
                    const allKittings = getAllKittingsInZone(zoneData);
                    const hasPret = allKittings.some(k => k.status === 'pret');
                    const hasIncomplet = allKittings.some(k => k.status === 'incomplet');
                    const subZoneCount = (zone.subZones || []).length;

                    let statusClass = '';
                    if (hasPret && hasIncomplet) statusClass = 'has-both';
                    else if (hasPret) statusClass = 'has-pret';
                    else if (hasIncomplet) statusClass = 'has-incomplet';

                    const subtitle = subZoneCount > 0
                        ? `${subZoneCount} sous-zone${subZoneCount > 1 ? 's' : ''} • ${allKittings.length} kitting${allKittings.length > 1 ? 's' : ''}`
                        : `${allKittings.length} kitting${allKittings.length > 1 ? 's' : ''}`;

                    return `
                        <div class="tree-item ${statusClass}" onclick="treeNavigateTo('subzones', '${zone.id}')">
                            <div class="tree-item-icon zone">📍</div>
                            <div class="tree-item-content">
                                <div class="tree-item-title">${escapeHtml(zone.name)}</div>
                                <div class="tree-item-subtitle">${subtitle}</div>
                            </div>
                            <div class="tree-item-badge">
                                <div class="tree-item-status">
                                    ${hasPret ? '<div class="tree-status-dot pret"></div>' : ''}
                                    ${hasIncomplet ? '<div class="tree-status-dot incomplet"></div>' : ''}
                                </div>
                                <span class="tree-item-count">${allKittings.length}</span>
                                <span class="tree-item-arrow">›</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } else if (treeNavState.level === 'subzones') {
                // Niveau 2 : Sous-zones d'une zone
                const zone = zoneConfig.zones.find(z => z.id === treeNavState.currentZone);
                if (!zone) {
                    treeNavigateTo('zones');
                    return;
                }

                backBtn.style.display = 'flex';
                breadcrumb.innerHTML = `
                    <span class="breadcrumb-item">Zones</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item active">${escapeHtml(zone.name)}</span>
                `;

                const zoneData = kittingsByLocation[zone.id] || { direct: [], subZones: {} };
                let html = '';

                // Afficher les sous-zones
                if (zone.subZones && zone.subZones.length > 0) {
                    html += zone.subZones.map(sz => {
                        const szKittings = zoneData.subZones[sz.id] || [];
                        const hasPret = szKittings.some(k => k.status === 'pret');
                        const hasIncomplet = szKittings.some(k => k.status === 'incomplet');

                        let statusClass = '';
                        if (hasPret && hasIncomplet) statusClass = 'has-both';
                        else if (hasPret) statusClass = 'has-pret';
                        else if (hasIncomplet) statusClass = 'has-incomplet';

                        return `
                            <div class="tree-item ${statusClass}" onclick="treeNavigateTo('kittings', '${zone.id}', '${sz.id}')">
                                <div class="tree-item-icon subzone">📦</div>
                                <div class="tree-item-content">
                                    <div class="tree-item-title">${escapeHtml(sz.name)}</div>
                                    <div class="tree-item-subtitle">${szKittings.length} kitting${szKittings.length > 1 ? 's' : ''}</div>
                                </div>
                                <div class="tree-item-badge">
                                    <div class="tree-item-status">
                                        ${hasPret ? '<div class="tree-status-dot pret"></div>' : ''}
                                        ${hasIncomplet ? '<div class="tree-status-dot incomplet"></div>' : ''}
                                    </div>
                                    <span class="tree-item-count">${szKittings.length}</span>
                                    <span class="tree-item-arrow">›</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Afficher les kittings directs (sans sous-zone)
                if (zoneData.direct.length > 0) {
                    html += `<div style="margin: 1rem 0 0.5rem; font-size: 0.85rem; color: var(--text-light); padding-left: 0.5rem;">Sans sous-zone :</div>`;
                    html += zoneData.direct.map(k => renderTreeKittingItem(k)).join('');
                }

                if (html === '') {
                    html = `
                        <div class="tree-empty">
                            <div class="tree-empty-icon">📭</div>
                            <p>Aucun contenu dans cette zone</p>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } else if (treeNavState.level === 'kittings') {
                // Niveau 3 : Kittings dans une sous-zone
                const zone = zoneConfig.zones.find(z => z.id === treeNavState.currentZone);
                const subZone = zone?.subZones?.find(sz => sz.id === treeNavState.currentSubZone);

                if (!zone || !subZone) {
                    treeNavigateTo('zones');
                    return;
                }

                backBtn.style.display = 'flex';
                breadcrumb.innerHTML = `
                    <span class="breadcrumb-item">Zones</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item">${escapeHtml(zone.name)}</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-item active">${escapeHtml(subZone.name)}</span>
                `;

                const zoneData = kittingsByLocation[zone.id] || { direct: [], subZones: {} };
                const szKittings = zoneData.subZones[subZone.id] || [];

                if (szKittings.length === 0) {
                    container.innerHTML = `
                        <div class="tree-empty">
                            <div class="tree-empty-icon">📭</div>
                            <p>Aucun kitting dans ${escapeHtml(subZone.name)}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = szKittings.map(k => renderTreeKittingItem(k)).join('');
            }
        }

        function renderTreeKittingItem(k) {
            const receivedCount = k.pieces.filter(p => p.received).length;
            const totalPieces = k.pieces.length;

            return `
                <div class="tree-kitting-item ${k.status}" onclick="openDetailView('${k.id}')">
                    <div class="tree-item-icon kitting ${k.status}">
                        ${k.status === 'pret' ? '✓' : '⏳'}
                    </div>
                    <div class="tree-kitting-info">
                        <div class="tree-kitting-ordre">${escapeHtml(k.ordre)}</div>
                        <div class="tree-kitting-pieces">${receivedCount}/${totalPieces} pièces reçues</div>
                    </div>
                    <span class="tree-kitting-status ${k.status}">
                        ${k.status === 'pret' ? 'Prêt' : 'Incomplet'}
                    </span>
                </div>
            `;
        }

        function treeNavigateTo(level, zoneId = null, subZoneId = null) {
            treeNavState.level = level;
            treeNavState.currentZone = zoneId;
            treeNavState.currentSubZone = subZoneId;
            renderTreeView();
        }

        function treeNavigateBack() {
            if (treeNavState.level === 'kittings') {
                treeNavigateTo('subzones', treeNavState.currentZone);
            } else if (treeNavState.level === 'subzones') {
                treeNavigateTo('zones');
            }
        }

        // ============================================
        // MAP RENDERING
        // ============================================

        function renderMap() {
            const container = document.getElementById('floorPlanInner');

            // Remove existing zones (keep building outline)
            container.querySelectorAll('.map-zone').forEach(el => el.remove());

            // Get kittings grouped by zone and sub-zone
            const kittingsByLocation = groupKittingsByLocation();

            // Render each zone
            zoneConfig.zones.forEach(zone => {
                const zoneData = kittingsByLocation[zone.id] || { direct: [], subZones: {} };
                const allZoneKittings = getAllKittingsInZone(zoneData);
                const hasPret = allZoneKittings.some(k => k.status === 'pret');
                const hasIncomplet = allZoneKittings.some(k => k.status === 'incomplet');

                let statusClass = '';
                if (hasPret && hasIncomplet) statusClass = 'has-both';
                else if (hasPret) statusClass = 'has-pret';
                else if (hasIncomplet) statusClass = 'has-incomplet';

                const zoneEl = document.createElement('div');
                zoneEl.className = `map-zone ${statusClass} ${editMode ? 'editing' : ''}`;
                zoneEl.style.left = zone.x + 'px';
                zoneEl.style.top = zone.y + 'px';
                zoneEl.style.width = zone.width + 'px';
                zoneEl.style.height = zone.height + 'px';
                zoneEl.dataset.zoneId = zone.id;

                if (editMode) {
                    zoneEl.style.cursor = 'move';
                    zoneEl.onmousedown = (e) => initDrag(e, zone.id, 'move');
                    zoneEl.ontouchstart = (e) => initDrag(e, zone.id, 'move');
                    zoneEl.ondblclick = () => openEditZoneModal(zone.id);
                }

                // Check if zone has sub-zones
                const hasSubZones = zone.subZones && zone.subZones.length > 0;

                let contentHtml = '';
                if (hasSubZones) {
                    // Render sub-zones as a grid
                    contentHtml = `
                        <div class="zone-subzones">
                            ${zone.subZones.map(sz => {
                                const szKittings = zoneData.subZones[sz.id] || [];
                                const szHasPret = szKittings.some(k => k.status === 'pret');
                                const szHasIncomplet = szKittings.some(k => k.status === 'incomplet');
                                let szClass = '';
                                if (szKittings.length > 0) {
                                    szClass = szHasIncomplet ? 'has-incomplet' : (szHasPret ? 'has-pret' : 'has-kitting');
                                }
                                return `
                                    <div class="sub-zone ${szClass}" title="${escapeHtml(sz.name)}">
                                        <div class="sub-zone-title">${escapeHtml(sz.name)}</div>
                                        <div class="sub-zone-content">
                                            ${szKittings.length > 0 ?
                                                szKittings.slice(0, 3).map(k => `
                                                    <div class="sub-zone-kitting ${k.status}"
                                                         onclick="event.stopPropagation(); openDetailView('${k.id}')"
                                                         title="${escapeHtml(k.ordre)}">
                                                        ${escapeHtml(k.ordre)}
                                                    </div>
                                                `).join('') + (szKittings.length > 3 ? `<div class="sub-zone-empty">+${szKittings.length - 3} autres</div>` : '') :
                                                '<div class="sub-zone-empty">Vide</div>'
                                            }
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${zoneData.direct.length > 0 ? `
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border);">
                                <div style="font-size: 0.7rem; color: var(--text-light); margin-bottom: 0.25rem;">Sans sous-zone:</div>
                                ${zoneData.direct.map(k => `
                                    <div class="map-kitting ${k.status}"
                                         onclick="event.stopPropagation(); openDetailView('${k.id}')"
                                         title="${escapeHtml(k.ordre)}">
                                        <span class="status-dot"></span>
                                        ${escapeHtml(k.ordre)}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                } else {
                    // No sub-zones - render kittings directly
                    contentHtml = `
                        <div class="zone-kittings">
                            ${allZoneKittings.length > 0 ?
                                allZoneKittings.map(k => `
                                    <div class="map-kitting ${k.status}"
                                         onclick="event.stopPropagation(); openDetailView('${k.id}')"
                                         title="${escapeHtml(k.ordre)} - ${escapeHtml(k.location)}">
                                        <span class="status-dot"></span>
                                        ${escapeHtml(k.ordre)}
                                    </div>
                                `).join('') :
                                '<div class="empty-zone-msg">Vide</div>'
                            }
                        </div>
                    `;
                }

                zoneEl.innerHTML = `
                    <div class="zone-header">
                        <span class="zone-title">${escapeHtml(zone.name)}</span>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <span class="zone-count">${allZoneKittings.length}</span>
                            <button class="zone-edit-btn" onclick="event.stopPropagation(); openEditZoneModal('${zone.id}')" title="Modifier la zone">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    ${contentHtml}
                    ${editMode ? `
                        <div class="zone-resize"
                             onmousedown="event.stopPropagation(); initDrag(event, '${zone.id}', 'resize')"
                             ontouchstart="event.stopPropagation(); initDrag(event, '${zone.id}', 'resize')">
                        </div>
                    ` : ''}
                `;

                container.appendChild(zoneEl);
            });

            // If no zones, show message
            if (zoneConfig.zones.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-light);';
                emptyMsg.innerHTML = `
                    <p>Aucune zone configurée</p>
                    <button class="btn btn-primary" onclick="openZoneConfigModal()" style="margin-top: 1rem;">
                        Ajouter une zone
                    </button>
                `;
                container.appendChild(emptyMsg);
            }

            // Appliquer la transparence des zones
            applyZoneTransparency();

            // Aussi mettre à jour la vue arborescente mobile
            renderTreeView();
        }

        // Group kittings by zone and sub-zone
        function groupKittingsByLocation() {
            const groups = {};

            // Initialize groups for all zones
            zoneConfig.zones.forEach(zone => {
                groups[zone.id] = {
                    direct: [],
                    subZones: {}
                };
                if (zone.subZones) {
                    zone.subZones.forEach(sz => {
                        groups[zone.id].subZones[sz.id] = [];
                    });
                }
            });

            kittings.forEach(k => {
                // Location format: "Zone A" or "Zone A > Case 1"
                const location = k.location || '';
                const subZoneId = k.subZone || null;

                // Find matching zone
                let matchedZone = null;
                for (const zone of zoneConfig.zones) {
                    if (k.zoneId === zone.id || location.toLowerCase().includes(zone.name.toLowerCase())) {
                        matchedZone = zone;
                        break;
                    }
                }

                if (matchedZone) {
                    if (subZoneId && groups[matchedZone.id].subZones[subZoneId] !== undefined) {
                        groups[matchedZone.id].subZones[subZoneId].push(k);
                    } else {
                        groups[matchedZone.id].direct.push(k);
                    }
                }
            });

            return groups;
        }

        // Get all kittings in a zone (including sub-zones)
        function getAllKittingsInZone(zoneData) {
            let all = [...zoneData.direct];
            Object.values(zoneData.subZones).forEach(szKittings => {
                all = all.concat(szKittings);
            });
            return all;
        }

        function getLocationSuggestions() {
            const suggestions = [];
            zoneConfig.zones.forEach(zone => {
                suggestions.push(zone.name);
                if (zone.subZones) {
                    zone.subZones.forEach(sz => {
                        suggestions.push(`${zone.name} > ${sz.name}`);
                    });
                }
            });
            return suggestions;
        }

        // ============================================
        // BACKGROUND IMAGE MANAGEMENT
        // ============================================

        function handleBackgroundImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Vérifier la taille du fichier (max 5MB pour localStorage)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image trop grande (max 5MB). Veuillez compresser l\'image.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageData = e.target.result;

                // Compresser l'image si nécessaire
                compressImage(imageData, (compressedData) => {
                    zoneConfig.backgroundImage = compressedData;
                    saveZoneConfigToStorage();
                    applyBackgroundImage();
                    showToast('Image de fond ajoutée');
                });
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function compressImage(dataUrl, callback) {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Redimensionner si trop grand
                const maxSize = 1500;
                if (width > maxSize || height > maxSize) {
                    if (width > height) {
                        height = (height / width) * maxSize;
                        width = maxSize;
                    } else {
                        width = (width / height) * maxSize;
                        height = maxSize;
                    }
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Compression JPEG à 80%
                const compressedData = canvas.toDataURL('image/jpeg', 0.8);
                callback(compressedData);
            };
            img.src = dataUrl;
        }

        function applyBackgroundImage() {
            const floorPlan = document.getElementById('floorPlan');
            const floorPlanInner = document.getElementById('floorPlanInner');
            const bgBanner = document.getElementById('bgImageBanner');

            if (zoneConfig.backgroundImage) {
                floorPlan.classList.add('has-background');
                floorPlan.style.backgroundImage = `url(${zoneConfig.backgroundImage})`;
                floorPlan.style.backgroundSize = zoneConfig.backgroundMode || 'contain';
                floorPlanInner.style.opacity = (zoneConfig.backgroundOpacity || 100) / 100;

                // Appliquer les dimensions
                if (zoneConfig.planWidth && zoneConfig.planHeight) {
                    floorPlanInner.style.minWidth = zoneConfig.planWidth + 'px';
                    floorPlanInner.style.minHeight = zoneConfig.planHeight + 'px';
                }

                bgBanner.classList.remove('hidden');
            } else {
                floorPlan.classList.remove('has-background');
                floorPlan.style.backgroundImage = '';
                floorPlanInner.style.opacity = 1;
                bgBanner.classList.add('hidden');
            }
        }

        function removeBackgroundImage() {
            if (confirm('Supprimer l\'image de fond ?')) {
                zoneConfig.backgroundImage = null;
                saveZoneConfigToStorage();
                applyBackgroundImage();
                closeModal('bgImageModal');
                showToast('Image de fond supprimée');
            }
        }

        function adjustBackgroundImage() {
            // Mettre à jour les valeurs du modal
            document.getElementById('bgImageMode').value = zoneConfig.backgroundMode || 'contain';
            document.getElementById('zoneTransparency').value = zoneConfig.zoneTransparency || 40;
            document.getElementById('transparencyValue').textContent = (zoneConfig.zoneTransparency || 40) + '%';
            document.getElementById('planWidth').value = zoneConfig.planWidth || 600;
            document.getElementById('planHeight').value = zoneConfig.planHeight || 400;

            openModal('bgImageModal');
        }

        function updateBackgroundMode() {
            const mode = document.getElementById('bgImageMode').value;
            zoneConfig.backgroundMode = mode;
            saveZoneConfigToStorage();
            applyBackgroundImage();
        }

        function updateZoneTransparency() {
            const transparency = document.getElementById('zoneTransparency').value;
            document.getElementById('transparencyValue').textContent = transparency + '%';
            zoneConfig.zoneTransparency = parseInt(transparency);
            saveZoneConfigToStorage();
            applyZoneTransparency();
        }

        function applyZoneTransparency() {
            const transparency = zoneConfig.zoneTransparency || 40;
            const opacity = (100 - transparency) / 100;

            document.querySelectorAll('.map-zone').forEach(zone => {
                zone.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;
            });
        }

        function applyPlanDimensions() {
            const width = parseInt(document.getElementById('planWidth').value) || 600;
            const height = parseInt(document.getElementById('planHeight').value) || 400;

            zoneConfig.planWidth = Math.max(400, Math.min(2000, width));
            zoneConfig.planHeight = Math.max(300, Math.min(1500, height));

            saveZoneConfigToStorage();
            applyBackgroundImage();
            showToast('Dimensions appliquées');
        }

        // Modifier loadZoneConfig pour charger l'image de fond
        const originalLoadZoneConfig = loadZoneConfig;
        loadZoneConfig = function() {
            const stored = localStorage.getItem('zoneConfig');
            if (stored) {
                const parsed = JSON.parse(stored);
                zoneConfig = {
                    ...zoneConfig,
                    ...parsed
                };
            }
            // Appliquer l'image de fond après le chargement
            setTimeout(() => {
                applyBackgroundImage();
            }, 100);
        };

        // ============================================
        // ZOOM CONTROLS
        // ============================================

        function zoomIn() {
            if (currentZoom < 300) {
                currentZoom += 25;
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > 25) {
                currentZoom -= 25;
                applyZoom();
            }
        }

        function resetZoom() {
            currentZoom = 100;
            applyZoom();
            // Réinitialiser aussi la position de scroll
            const floorPlan = document.getElementById('floorPlan');
            floorPlan.scrollTop = 0;
            floorPlan.scrollLeft = 0;
        }

        function applyZoom() {
            const floorPlanInner = document.getElementById('floorPlanInner');
            const zoomLevelDisplay = document.getElementById('zoomLevel');
            const floorPlan = document.getElementById('floorPlan');

            const scale = currentZoom / 100;
            floorPlanInner.style.transform = `scale(${scale})`;
            floorPlanInner.style.transformOrigin = 'top left';

            // Ajuster la taille pour permettre le scroll
            const baseWidth = zoneConfig.planWidth || 800;
            const baseHeight = zoneConfig.planHeight || 600;

            // Le contenu interne doit être plus grand que le conteneur visible
            floorPlanInner.style.width = baseWidth + 'px';
            floorPlanInner.style.height = baseHeight + 'px';
            floorPlanInner.style.minWidth = (baseWidth * scale) + 'px';
            floorPlanInner.style.minHeight = (baseHeight * scale) + 'px';

            zoomLevelDisplay.textContent = currentZoom + '%';

            // Afficher info debug
            console.log('Zoom:', currentZoom + '%', 'Size:', baseWidth * scale, 'x', baseHeight * scale);
        }

        // ============================================
        // PAN / DÉPLACEMENT TACTILE ET SOURIS
        // ============================================

        let isPanning = false;
        let panStartX = 0;
        let panStartY = 0;
        let panScrollLeft = 0;
        let panScrollTop = 0;

        function initPanZoom() {
            const floorPlan = document.getElementById('floorPlan');
            if (!floorPlan) return;

            // Zoom avec la molette de la souris (Ctrl + molette ou juste molette)
            floorPlan.addEventListener('wheel', (e) => {
                // Zoom avec Ctrl+molette OU si le plan est zoomé > 100%
                if (e.ctrlKey || currentZoom > 100) {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        zoomIn();
                    } else {
                        zoomOut();
                    }
                }
            }, { passive: false });

            // Pan avec la souris (drag) - fonctionne toujours sauf en mode édition
            floorPlan.addEventListener('mousedown', (e) => {
                // Ne pas activer le pan si on clique sur une zone en mode édition
                if (editMode && e.target.closest('.map-zone')) return;
                // Ne pas activer si clic sur un bouton ou lien
                if (e.target.closest('button, a, .map-kitting')) return;

                isPanning = true;
                floorPlan.classList.add('panning');
                panStartX = e.clientX;
                panStartY = e.clientY;
                panScrollLeft = floorPlan.scrollLeft;
                panScrollTop = floorPlan.scrollTop;
                e.preventDefault();
            });

            // Utiliser document pour capturer les mouvements même hors du plan
            document.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                const dx = e.clientX - panStartX;
                const dy = e.clientY - panStartY;
                floorPlan.scrollLeft = panScrollLeft - dx;
                floorPlan.scrollTop = panScrollTop - dy;
            });

            document.addEventListener('mouseup', () => {
                if (isPanning) {
                    isPanning = false;
                    const fp = document.getElementById('floorPlan');
                    if (fp) {
                        fp.classList.remove('panning');
                    }
                }
            });

            // Pan tactile (touch)
            let touchStartX = 0;
            let touchStartY = 0;

            floorPlan.addEventListener('touchstart', (e) => {
                if (e.target.closest('.map-zone') && editMode) return;
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].pageX;
                    touchStartY = e.touches[0].pageY;
                    panScrollLeft = floorPlan.scrollLeft;
                    panScrollTop = floorPlan.scrollTop;
                }
            }, { passive: true });

            floorPlan.addEventListener('touchmove', (e) => {
                if (e.target.closest('.map-zone') && editMode) return;
                if (e.touches.length === 1) {
                    const x = e.touches[0].pageX;
                    const y = e.touches[0].pageY;
                    const walkX = touchStartX - x;
                    const walkY = touchStartY - y;
                    floorPlan.scrollLeft = panScrollLeft + walkX;
                    floorPlan.scrollTop = panScrollTop + walkY;
                }
            }, { passive: true });

            // Pinch to zoom (deux doigts)
            let initialPinchDistance = 0;
            let initialZoom = 100;

            floorPlan.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialPinchDistance = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    initialZoom = currentZoom;
                }
            }, { passive: true });

            floorPlan.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const scale = currentDistance / initialPinchDistance;
                    let newZoom = Math.round(initialZoom * scale);
                    newZoom = Math.max(25, Math.min(300, newZoom));
                    // Arrondir au multiple de 25 le plus proche
                    newZoom = Math.round(newZoom / 25) * 25;
                    if (newZoom !== currentZoom) {
                        currentZoom = newZoom;
                        applyZoom();
                    }
                }
            }, { passive: false });
        }

        // Initialiser le pan/zoom au chargement
        document.addEventListener('DOMContentLoaded', initPanZoom);
    </script>
</body>
</html>
